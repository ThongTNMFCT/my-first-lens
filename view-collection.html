<!DOCTYPE html>
<html lang="vi" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album Detail | Thong Tran Photography</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,500;1,600&family=Montserrat:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        serif: ['Cormorant Garamond', 'serif'],
                    },
                    colors: {
                        darkBg: '#050505',
                        lightBg: '#f8f8f8',
                        accent: '#d4af37',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 1s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-nav {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-sidebar {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        #comments-list::-webkit-scrollbar { width: 2px; }
        
        .photo-item { break-inside: avoid; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-lightBg dark:bg-darkBg text-zinc-900 dark:text-zinc-200 antialiased transition-colors duration-700">

    <!-- Navigation -->
    <nav id="navbar" class="fixed top-0 left-0 w-full z-50 px-8 py-6 transition-all duration-500">
        <div class="max-w-screen-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-6">
                <a href="collection.html" class="w-10 h-10 rounded-full border border-zinc-200 dark:border-zinc-800 flex items-center justify-center hover:border-accent hover:text-accent transition-all group" title="Back to Collections">
                    <i class="fas fa-arrow-left text-xs group-hover:-translate-x-0.5 transition-transform"></i>
                </a>
                <a href="index.html" class="font-serif text-2xl font-medium tracking-tight hover:text-accent transition-colors">
                    Thong Tran<span class="text-accent">.</span>
                </a>
            </div>

            <div class="flex items-center gap-8 relative z-50">
                <div class="hidden sm:flex items-center gap-3 text-[10px] font-bold tracking-widest">
                    <button onclick="setLanguage('vi')" id="btn-vi" class="opacity-40 hover:opacity-100 transition-opacity">VN</button>
                    <span class="opacity-20 text-xs font-light">/</span>
                    <button onclick="setLanguage('en')" id="btn-en" class="opacity-40 hover:opacity-100 transition-opacity">EN</button>
                </div>
                
                <button id="theme-toggle" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-zinc-200 dark:hover:bg-white/10 transition-all">
                    <i class="fas fa-moon dark:hidden text-xs"></i> 
                    <i class="fas fa-sun hidden dark:block text-xs text-accent"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <header class="pt-40 pb-16 px-6 text-center max-w-4xl mx-auto relative z-10">
        <div class="opacity-0 animate-fade-in-up">
            <p id="album-meta" class="text-accent text-[10px] md:text-xs font-bold uppercase tracking-[0.3em] mb-6">
                <!-- Location & Date will load here -->
                Loading...
            </p>
            <h1 id="album-title" class="font-serif text-5xl md:text-7xl italic font-light text-zinc-900 dark:text-zinc-100 leading-tight mb-8">
                <!-- Title -->
            </h1>
            <p id="album-desc" class="font-sans text-sm font-light leading-relaxed text-zinc-600 dark:text-zinc-400 max-w-2xl mx-auto">
                <!-- Description -->
            </p>
        </div>
        <div class="mt-12 h-12 w-[1px] bg-gradient-to-b from-transparent via-accent to-transparent mx-auto opacity-0 animate-fade-in-up" style="animation-delay: 0.2s;"></div>
    </header>

    <!-- Main Content: Masonry Grid -->
    <main class="max-w-screen-2xl mx-auto px-6 md:px-12 pb-32 min-h-[50vh]">
        <div id="photo-container" class="columns-1 md:columns-2 lg:columns-3 gap-8 space-y-8">
            <!-- Photos will be injected here -->
            <div class="col-span-full text-center text-zinc-500 italic text-sm py-20 opacity-0 animate-fade-in">Loading archive assets...</div>
        </div>
    </main>

    <!-- Lightbox Modal -->
    <div id="lightboxModal" class="fixed inset-0 z-[100] hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-white/95 dark:bg-black/95 backdrop-blur-md transition-opacity" onclick="closeLightbox()"></div>
        
        <!-- Close Button -->
        <button onclick="closeLightbox()" class="absolute top-6 right-6 z-[120] w-10 h-10 flex items-center justify-center rounded-full hover:bg-zinc-100 dark:hover:bg-white/10 transition-colors">
            <i class="fas fa-times text-zinc-500 dark:text-zinc-400"></i>
        </button>

        <div class="absolute inset-0 md:inset-8 flex flex-col lg:flex-row overflow-hidden z-[110] shadow-2xl rounded-sm">
            
            <!-- Image Area -->
            <div class="w-full lg:w-3/4 h-2/3 lg:h-full flex items-center justify-center bg-transparent relative p-4 lg:p-10 pointer-events-none">
                <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain shadow-lg pointer-events-auto transition-transform duration-500">
            </div>

            <!-- Sidebar Info -->
            <div class="w-full lg:w-1/4 h-1/3 lg:h-full bg-white dark:bg-[#0a0a0a] lg:glass-sidebar border-t lg:border-t-0 lg:border-l border-zinc-200 dark:border-zinc-800 flex flex-col pointer-events-auto">
                
                <!-- Metadata -->
                <div class="p-6 md:p-8 border-b border-zinc-200 dark:border-white/5 space-y-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[9px] uppercase tracking-widest text-zinc-400 mb-1">Captured</p>
                            <p id="meta-date" class="font-serif italic text-lg text-zinc-800 dark:text-zinc-200">--</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] uppercase tracking-widest text-zinc-400 mb-1">Location</p>
                            <p id="meta-location" class="font-serif italic text-lg text-zinc-800 dark:text-zinc-200">--</p>
                        </div>
                    </div>

                    <!-- EXIF Grid -->
                    <div id="meta-exif" class="grid grid-cols-4 gap-2 pt-4 border-t border-zinc-200 dark:border-white/5">
                        <div class="text-center space-y-1">
                            <i class="fas fa-camera text-[10px] text-accent"></i>
                            <p id="exif-camera" class="text-[9px] font-bold truncate opacity-60">--</p>
                        </div>
                        <div class="text-center space-y-1">
                            <i class="fas fa-dot-circle text-[10px] text-accent"></i>
                            <p id="exif-aperture" class="text-[9px] font-bold opacity-60">--</p>
                        </div>
                        <div class="text-center space-y-1">
                            <i class="fas fa-bolt text-[10px] text-accent"></i>
                            <p id="exif-shutter" class="text-[9px] font-bold opacity-60">--</p>
                        </div>
                        <div class="text-center space-y-1">
                            <i class="fas fa-adjust text-[10px] text-accent"></i>
                            <p id="exif-iso" class="text-[9px] font-bold opacity-60">--</p>
                        </div>
                    </div>
                </div>

                <!-- Interaction Header -->
                <div class="px-6 py-4 flex justify-between items-center bg-zinc-50 dark:bg-white/5 border-b border-zinc-200 dark:border-white/5">
                    <h4 class="font-serif italic text-lg" data-i18n="comments_title">Comments</h4>
                    <button id="btn-like" onclick="toggleLike()" class="flex items-center gap-2 group text-zinc-400 hover:text-red-500 transition-colors">
                        <i id="icon-heart" class="far fa-heart text-lg group-hover:scale-110 transition-transform"></i>
                        <span id="like-count" class="text-[10px] font-bold">0</span>
                    </button>
                </div>

                <!-- Comments List -->
                <div id="comments-list" class="flex-1 overflow-y-auto p-6 space-y-4 bg-white dark:bg-transparent">
                    <p class="text-center text-zinc-400 text-xs italic mt-4">Loading discussion...</p>
                </div>

                <!-- Input Area -->
                <div class="p-5 border-t border-zinc-200 dark:border-white/5 bg-zinc-50 dark:bg-black/20">
                    <div class="relative">
                        <input type="text" id="comment-input" placeholder="Share your thoughts..." 
                               class="w-full bg-transparent border-b border-zinc-300 dark:border-zinc-700 py-3 pr-10 text-xs focus:outline-none focus:border-accent transition-colors"
                               onkeypress="if(event.key === 'Enter') postComment()">
                        <button onclick="postComment()" class="absolute right-0 bottom-3 text-zinc-400 hover:text-accent transition-colors">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-24 px-6 md:px-20 border-t border-zinc-200 dark:border-zinc-800 bg-lightBg dark:bg-darkBg">
        <div class="max-w-screen-2xl mx-auto flex flex-col md:flex-row justify-between items-start gap-12">
            <div class="space-y-6 max-w-md">
                <a href="#" class="font-serif text-4xl font-bold tracking-tighter block">Thong Tran<span class="text-accent">.</span></a>
                <p class="text-xs font-light text-zinc-500 leading-relaxed">
                    Captured with passion. Preserved for eternity. <br>
                    Based in Mekong Delta, Vietnam.
                </p>
                
                <!-- Day Counter Widget -->
                <div class="inline-flex items-center gap-3 px-4 py-2 border border-zinc-200 dark:border-zinc-800 rounded-full bg-white dark:bg-zinc-900/50">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-accent"></span>
                    </span>
                    <p class="text-[9px] uppercase tracking-widest font-bold text-zinc-600 dark:text-zinc-300">
                        <span data-i18n="journey_text">Hành trình</span>: <span id="days-count" class="font-mono text-accent">0</span> <span data-i18n="days_label">Ngày</span>
                    </p>
                </div>
            </div>
            
            <div class="flex flex-col gap-4 text-right">
                <p class="text-[10px] font-bold uppercase tracking-widest text-zinc-400 mb-2">Connect</p>
                <a href="#" class="text-sm font-medium hover:text-accent transition-colors">Instagram</a>
                <a href="#" class="text-sm font-medium hover:text-accent transition-colors">Facebook</a>
                <a href="#" class="text-sm font-medium hover:text-accent transition-colors">Email</a>
            </div>
        </div>
        <div class="mt-20 pt-8 border-t border-zinc-200 dark:border-zinc-800 flex flex-col md:flex-row justify-between items-center gap-4 text-[10px] uppercase tracking-widest text-zinc-400">
            <p>&copy; 2026 Thong Tran. All Rights Reserved.</p>
            <p>Designed for My First Lens</p>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>

    <script>
        // --- 1. LANGUAGE LOGIC ---
        const translations = {
            vi: {
                nav_collection: "Bộ Sưu Tập",
                nav_about: "Góc Nhìn",
                comments_title: "Bình luận",
                placeholder_comment: "Chia sẻ cảm nghĩ...",
                guest_name: "Khách tham quan",
                journey_text: "Hành trình",
                days_label: "Ngày",
                loading_archive: "Đang tải kho lưu trữ...",
                empty_photos: "Album này chưa có ảnh nào."
            },
            en: {
                nav_collection: "Collection",
                nav_about: "Perspective",
                comments_title: "Comments",
                placeholder_comment: "Share your thoughts...",
                guest_name: "Visitor",
                journey_text: "Journaling",
                days_label: "Days",
                loading_archive: "Loading archive assets...",
                empty_photos: "No photos in this archive yet."
            }
        };

        function setLanguage(lang) {
            localStorage.setItem('lang', lang);
            const t = translations[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerHTML = t[key];
            });

            const input = document.getElementById('comment-input');
            if(input) input.placeholder = t.placeholder_comment;

            const btnVi = document.getElementById('btn-vi');
            const btnEn = document.getElementById('btn-en');
            if (lang === 'vi') {
                btnVi.classList.replace('opacity-40', 'opacity-100'); btnVi.classList.add('text-accent');
                btnEn.classList.replace('opacity-100', 'opacity-40'); btnEn.classList.remove('text-accent');
            } else {
                btnEn.classList.replace('opacity-40', 'opacity-100'); btnEn.classList.add('text-accent');
                btnVi.classList.replace('opacity-100', 'opacity-40'); btnVi.classList.remove('text-accent');
            }
        }

        // --- 2. LOGIC COUNTER ---
        function updateDaysCounter() {
            const startDate = new Date('2026-01-01');
            const now = new Date();
            const diffTime = now - startDate;
            let days = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            if (days < 0) days = 0;
            const el = document.getElementById('days-count');
            if(el) el.innerText = days;
        }

        // --- 3. FIREBASE LOGIC ---
        if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
        const db = firebase.firestore();
        
        let currentPhotoId = null;
        let unsubscribeComments = null;
        let unsubscribeLikes = null;

        async function loadAlbumDataAndPhotos() {
            const urlParams = new URLSearchParams(window.location.search);
            const albumId = urlParams.get('id');
            const container = document.getElementById('photo-container');
            const lang = localStorage.getItem('lang') || 'vi';

            if (!albumId) { window.location.href = 'collection.html'; return; }

            try {
                // Load Album Info
                const albumDoc = await db.collection('albums').doc(albumId).get();
                let albumData = {};
                
                if (albumDoc.exists) {
                    albumData = albumDoc.data();
                    document.getElementById('album-title').innerText = albumData.title;
                    document.getElementById('album-desc').innerText = albumData.description || "";
                    
                    const date = albumData.dateTaken ? new Date(albumData.dateTaken).toLocaleDateString('en-GB') : "Archive";
                    const loc = albumData.location || "Vietnam";
                    document.getElementById('album-meta').innerText = `${loc} — ${date}`;
                    
                    document.title = `${albumData.title} | Thong Tran`;
                }

                // Load Photos
                const snapshot = await db.collection('photos')
                    .where('albumId', '==', albumId)
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = `<p class="col-span-full text-center text-zinc-500 italic py-20">${translations[lang].empty_photos}</p>`;
                    return;
                }

                let html = '';
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const thumb = data.url.replace('/upload/', '/upload/w_800,q_auto,f_auto/');
                    const safeLoc = (data.caption || albumData.location || 'Unknown').replace(/'/g, "\\'");
                    
                    // Priority for date: Photo > Album > Created
                    let dateTaken = "N/A";
                    if (data.takenDate) dateTaken = new Date(data.takenDate).toLocaleDateString('en-GB');
                    else if (albumData.dateTaken) dateTaken = new Date(albumData.dateTaken).toLocaleDateString('en-GB');
                    else if (data.createdAt) dateTaken = new Date(data.createdAt.seconds * 1000).toLocaleDateString('en-GB');

                    const exifJSON = data.exif ? encodeURIComponent(JSON.stringify(data.exif)) : '';

                    // Masonry Item
                    html += `
                    <div class="photo-item group relative overflow-hidden rounded-sm cursor-zoom-in animate-fade-in" 
                         style="animation-delay: ${index * 0.05}s"
                         onclick="openLightbox('${data.url}', '${doc.id}', '${safeLoc}', '${dateTaken}', '${exifJSON}')">
                        <img src="${thumb}" class="w-full h-auto block transition-transform duration-700 group-hover:scale-105" loading="lazy">
                        <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        
                        <div class="absolute bottom-4 left-4 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-4 group-hover:translate-y-0">
                             <div class="flex items-center gap-2 text-white/90">
                                <i class="fas fa-heart text-xs"></i> 
                                <span class="text-[10px] font-bold">${data.likes || 0}</span>
                             </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;

            } catch (e) { console.error(e); }
        }

        // --- 4. LIGHTBOX & INTERACTION ---
        window.openLightbox = function(url, photoId, location, date, exifString) {
            currentPhotoId = photoId;
            const modal = document.getElementById('lightboxModal');
            
            document.getElementById('lightbox-img').src = url;
            document.getElementById('meta-location').innerText = location;
            document.getElementById('meta-date').innerText = date;

            // EXIF
            const exifContainer = document.getElementById('meta-exif');
            if (exifString) {
                try {
                    const exif = JSON.parse(decodeURIComponent(exifString));
                    if (exif.camera && exif.camera !== 'Unknown Camera') {
                        document.getElementById('exif-camera').innerText = exif.camera;
                        document.getElementById('exif-aperture').innerText = exif.aperture || '--';
                        document.getElementById('exif-shutter').innerText = exif.shutter || '--';
                        document.getElementById('exif-iso').innerText = exif.iso || '--';
                        exifContainer.classList.remove('opacity-20');
                    } else {
                        exifContainer.classList.add('opacity-20'); // Dim if no valid EXIF
                    }
                } catch(e) {}
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Realtime Listeners
            checkLikeStatus(photoId);
            if(unsubscribeLikes) unsubscribeLikes();
            unsubscribeLikes = db.collection('photos').doc(photoId).onSnapshot(doc => {
                if(doc.exists) document.getElementById('like-count').innerText = doc.data().likes || 0;
            });
            loadRealtimeComments(photoId);
        };

        window.closeLightbox = function() {
            const modal = document.getElementById('lightboxModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            if(unsubscribeComments) unsubscribeComments();
            if(unsubscribeLikes) unsubscribeLikes();
            setTimeout(() => document.getElementById('lightbox-img').src = '', 200);
        };

        function loadRealtimeComments(photoId) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '<div class="text-center mt-10"><i class="fas fa-circle-notch fa-spin text-zinc-400"></i></div>';
            
            if(unsubscribeComments) unsubscribeComments();
            unsubscribeComments = db.collection('photos').doc(photoId).collection('comments').orderBy('createdAt', 'desc')
                .onSnapshot(snap => {
                    if(snap.empty) {
                        list.innerHTML = '<p class="text-center text-zinc-400 text-[10px] italic mt-10">No comments yet.</p>';
                        return;
                    }
                    let html = '';
                    snap.forEach(doc => {
                        const c = doc.data();
                        const time = c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                        html += `
                        <div class="mb-4 animate-fade-in">
                            <div class="flex justify-between items-baseline mb-1">
                                <p class="text-[9px] font-bold uppercase tracking-widest text-accent">${c.name || 'Guest'}</p>
                                <p class="text-[8px] text-zinc-400">${time}</p>
                            </div>
                            <p class="text-xs text-zinc-600 dark:text-zinc-300 leading-relaxed bg-zinc-50 dark:bg-white/5 p-3 rounded-sm rounded-tl-none">${c.content}</p>
                        </div>`;
                    });
                    list.innerHTML = html;
                });
        }

        window.postComment = async function() {
            if(!currentPhotoId) return;
            const input = document.getElementById('comment-input');
            const content = input.value.trim();
            if(content) {
                const lang = localStorage.getItem('lang') || 'vi';
                const guestName = translations[lang].guest_name;
                try {
                    await db.collection('photos').doc(currentPhotoId).collection('comments').add({
                        content: content, name: guestName, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    input.value = '';
                } catch(e) { console.error(e); }
            }
        };

        function checkLikeStatus(id) {
            const liked = JSON.parse(localStorage.getItem('liked_photos') || '[]');
            const icon = document.getElementById('icon-heart');
            if (liked.includes(id)) {
                icon.classList.replace('far', 'fas'); icon.classList.add('text-red-500');
            } else {
                icon.classList.replace('fas', 'far'); icon.classList.remove('text-red-500');
            }
        }

        window.toggleLike = async function() {
            if(!currentPhotoId) return;
            const liked = JSON.parse(localStorage.getItem('liked_photos') || '[]');
            const isLiked = liked.includes(currentPhotoId);
            const ref = db.collection('photos').doc(currentPhotoId);
            if (!isLiked) {
                liked.push(currentPhotoId); await ref.update({ likes: firebase.firestore.FieldValue.increment(1) });
            } else {
                const index = liked.indexOf(currentPhotoId); liked.splice(index, 1);
                await ref.update({ likes: firebase.firestore.FieldValue.increment(-1) });
            }
            localStorage.setItem('liked_photos', JSON.stringify(liked));
            checkLikeStatus(currentPhotoId);
        };

        // --- 5. INIT & THEME ---
        document.addEventListener('DOMContentLoaded', () => {
            const currentLang = localStorage.getItem('lang') || 'vi';
            setLanguage(currentLang);
            updateDaysCounter();
            loadAlbumDataAndPhotos();
            
            const html = document.documentElement;
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
            }
        });

        document.getElementById('theme-toggle').addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('color-theme', 'dark');
            }
        });

        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) navbar.classList.add('glass-nav', 'py-4');
            else navbar.classList.remove('glass-nav', 'py-4');
        });
    </script>
</body>
</html>