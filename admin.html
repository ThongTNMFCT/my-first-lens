<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Thong Tran</title>
    
    <!-- RESOURCES -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Great+Vibes&family=Inter:wght@200;300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,700&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        display: ['Cormorant Garamond', 'serif'],
                        signature: ['Great Vibes', 'cursive'],
                    },
                    colors: {
                        accent: '#c5a059',
                        darkPanel: '#050505',
                        lightBg: '#fafafa',
                        borderLight: '#e5e7eb'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fafafa; color: #18181b; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #c5a059; }

        /* SweetAlert Light Theme */
        .swal2-popup { border-radius: 4px !important; font-family: 'Inter', sans-serif !important; }
        .swal2-title { font-family: 'Playfair Display', serif !important; color: #18181b !important; }
        .swal2-confirm { background-color: #c5a059 !important; color: #000 !important; font-weight: bold !important; border-radius: 2px !important; text-transform: uppercase; letter-spacing: 0.1em; }
        .swal2-cancel { background-color: #f3f4f6 !important; color: #374151 !important; }
        
        .custom-loader {
            width: 16px; height: 16px;
            border: 2px solid #000; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Radio/Button Styles */
        .color-radio:checked + label { border-color: #c5a059; background-color: rgba(197, 160, 89, 0.1); color: #c5a059; }
        .type-radio:checked + label { background-color: #18181b; color: #fff; border-color: #18181b; }
        .pos-radio:checked + label { border-color: #18181b; background-color: #18181b; color: #fff; }
        
        /* Format Toolbar Buttons */
        .fmt-btn { @apply w-8 h-8 border border-zinc-200 text-zinc-500 flex items-center justify-center hover:bg-zinc-100 transition-all rounded-sm; }
        .fmt-btn.active { @apply bg-zinc-800 text-white border-zinc-800; }
    </style>
</head>
<body class="antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-white">
        <div class="w-full max-w-sm space-y-12 text-center">
            <div class="space-y-4">
                <h1 class="font-serif text-5xl italic font-bold tracking-wide text-zinc-900">Thong Tran<span class="text-accent">.</span></h1>
                <p class="text-[9px] uppercase tracking-[0.4em] text-zinc-400 font-bold">Admin Portal</p>
            </div>
            <div class="space-y-6 text-left">
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Identity</label>
                    <input type="text" id="adminUser" value="admin" class="w-full bg-transparent border-b border-zinc-200 py-3 text-zinc-900 focus:outline-none focus:border-accent transition-colors text-sm">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Credential</label>
                    <input type="password" id="adminPass" value="admin" class="w-full bg-transparent border-b border-zinc-200 py-3 text-zinc-900 focus:outline-none focus:border-accent transition-colors text-sm">
                </div>
            </div>
            <button onclick="checkLogin()" class="w-full bg-zinc-900 text-white py-4 text-[10px] font-bold uppercase tracking-[0.3em] hover:bg-accent transition-all duration-500 shadow-lg">Unlock</button>
        </div>
    </div>

    <!-- Dashboard Main -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-white border-r border-zinc-200 flex-shrink-0 flex flex-col h-auto md:h-screen sticky top-0 z-50">
            <div class="p-8 border-b border-zinc-100 flex justify-between items-center md:block space-y-2">
                <span class="font-serif font-bold text-2xl italic tracking-wide text-zinc-900">Thong Tran<span class="text-accent">.</span></span>
                <p class="text-[8px] uppercase tracking-widest text-zinc-400 font-bold hidden md:block">Management System</p>
                <button onclick="logout()" class="md:hidden text-zinc-400"><i class="fas fa-power-off"></i></button>
            </div>
            
            <nav class="flex-1 p-6 space-y-2 text-[10px] font-bold uppercase tracking-widest">
                <a href="index.html" target="_blank" class="flex items-center gap-4 p-4 rounded-sm hover:bg-zinc-50 text-zinc-500 hover:text-accent transition-all">
                    <i class="fas fa-external-link-alt w-4"></i> Live Site
                </a>
                <div class="h-px bg-zinc-100 my-4"></div>
                <button onclick="switchView('albums')" class="w-full flex items-center gap-4 p-4 rounded-sm hover:bg-zinc-50 text-zinc-500 hover:text-accent transition-all text-left">
                    <i class="fas fa-th-large w-4"></i> Albums
                </button>
                <button onclick="createNewAlbum()" class="w-full flex items-center gap-4 p-4 rounded-sm bg-zinc-900 text-white hover:bg-accent transition-all shadow-lg mt-4 text-left">
                    <i class="fas fa-plus w-4"></i> Create Album
                </button>
            </nav>

            <div class="p-8 border-t border-zinc-100 hidden md:block">
                <button onclick="logout()" class="flex items-center gap-3 text-red-400 hover:text-red-600 transition-colors text-[10px] font-bold uppercase tracking-widest">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 p-8 md:p-16 overflow-auto bg-[#fafafa]">
            
            <!-- Albums View -->
            <div id="view-albums" class="animate-fade-in">
                <div class="mb-12">
                    <h2 class="font-display text-4xl md:text-5xl text-zinc-900 mb-2">Kho Lưu Trữ</h2>
                    <p class="text-[10px] uppercase tracking-[0.3em] text-zinc-400 font-bold">Quản lý các bộ sưu tập ảnh</p>
                </div>
                <div id="admin-album-list" class="grid grid-cols-1 gap-6 max-w-5xl"></div>
            </div>

            <!-- Photos View -->
            <div id="view-photos" class="hidden animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-8 mb-12 border-b border-zinc-200 pb-8">
                    <div class="flex items-center gap-6">
                        <button onclick="switchView('albums')" class="w-12 h-12 rounded-full border border-zinc-300 flex items-center justify-center hover:bg-zinc-900 hover:text-white transition-all group bg-white">
                            <i class="fas fa-arrow-left text-xs text-zinc-500 group-hover:text-white"></i>
                        </button>
                        <div>
                            <h2 id="current-album-title" class="font-display text-3xl md:text-4xl text-zinc-900">Album Title</h2>
                            <p class="text-[9px] uppercase tracking-[0.3em] text-zinc-400 font-bold mt-1">Asset Intelligence Management</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                         <button onclick="downloadAlbumZip()" id="btn-download-zip" class="flex items-center gap-2 px-5 py-3 bg-white border border-zinc-200 text-zinc-700 rounded-sm text-[10px] uppercase font-bold tracking-widest hover:bg-zinc-900 hover:text-white hover:border-zinc-900 transition-colors shadow-sm">
                             <i class="fas fa-file-archive"></i> Download ZIP
                         </button>
                    </div>
                </div>
                <div id="admin-photo-grid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            </div>
        </main>
    </div>

    <!-- Upload Modal (With Advanced Text Tools) -->
    <div id="uploadModal" class="hidden fixed inset-0 z-[150] overflow-y-auto bg-white/95 backdrop-blur-xl">
        <div class="flex min-h-full justify-center p-6">
            <div class="w-full max-w-7xl space-y-10 py-10 relative my-auto">
                <button onclick="closeUploadModal()" class="absolute top-0 right-0 z-50 w-10 h-10 rounded-full bg-zinc-100 hover:bg-zinc-200 flex items-center justify-center transition-colors text-zinc-500">
                    <i class="fas fa-times"></i>
                </button>

                <div class="text-center space-y-3">
                    <h3 class="font-display text-4xl text-zinc-900">Upload Assets</h3>
                    <p class="text-[9px] uppercase tracking-[0.5em] text-zinc-400 font-bold">Synchronizing Vision with Cloud</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start">
                    
                    <!-- Right: Settings Panel -->
                    <div class="lg:col-span-4 bg-white border border-zinc-200 p-8 space-y-8 rounded-sm sticky top-6 shadow-xl">
                        <div class="flex items-center justify-between border-b border-zinc-100 pb-4">
                            <p class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Identity Stamp</p>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="useWatermark" checked class="w-4 h-4 accent-accent" onchange="renderPreviews()">
                                <span class="text-[11px] font-bold uppercase tracking-widest text-zinc-900">Active</span>
                            </label>
                        </div>

                        <div class="space-y-6">
                            <!-- QR & Background Toggle -->
                            <div class="flex gap-4">
                                <div class="flex-1 flex items-center justify-between bg-zinc-50 p-4 border border-zinc-100 rounded-sm">
                                    <span class="text-[9px] font-bold uppercase tracking-widest text-zinc-800">QR Code</span>
                                    <input type="checkbox" id="useQR" class="w-4 h-4 accent-accent" onchange="renderPreviews()">
                                </div>
                                <div class="flex-1 flex items-center justify-between bg-zinc-50 p-4 border border-zinc-100 rounded-sm">
                                    <span class="text-[9px] font-bold uppercase tracking-widest text-zinc-800">Nền Mờ</span>
                                    <input type="checkbox" id="useBackground" checked class="w-4 h-4 accent-accent" onchange="renderPreviews()">
                                </div>
                            </div>

                            <!-- Style Radios -->
                            <div class="space-y-3">
                                <label class="text-[9px] uppercase font-bold text-zinc-400 tracking-wider">Visual Style</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="radio" name="wmType" id="type-custom" value="custom" checked class="hidden type-radio" onchange="toggleWMSettings()">
                                    <label for="type-custom" class="py-3 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 text-zinc-500 transition-all rounded-sm">Custom</label>
                                    
                                    <input type="radio" name="wmType" id="type-fixed-b" value="fixed_b" class="hidden type-radio" onchange="toggleWMSettings()">
                                    <label for="type-fixed-b" class="py-3 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 text-zinc-500 transition-all rounded-sm">Signature</label>
                                    
                                    <input type="radio" name="wmType" id="type-image" value="image" class="hidden type-radio" onchange="toggleWMSettings()">
                                    <label for="type-image" class="py-3 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 text-zinc-500 transition-all rounded-sm">Image Logo</label>
                                </div>
                            </div>

                            <!-- Text Inputs & Format Controls -->
                            <div id="text-config-panel" class="space-y-5">
                                <div id="custom-text-inputs" class="space-y-3">
                                    <!-- Toolbar -->
                                    <div class="flex items-center justify-between pb-1 border-b border-zinc-100">
                                        <div class="flex gap-1">
                                            <button onclick="toggleFormat('bold')" id="btn-bold" class="fmt-btn font-bold">B</button>
                                            <button onclick="toggleFormat('italic')" id="btn-italic" class="fmt-btn italic">I</button>
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick="toggleAlign('left')" id="btn-align-left" class="fmt-btn active"><i class="fas fa-align-left text-xs"></i></button>
                                            <button onclick="toggleAlign('center')" id="btn-align-center" class="fmt-btn"><i class="fas fa-align-center text-xs"></i></button>
                                            <button onclick="toggleAlign('right')" id="btn-align-right" class="fmt-btn"><i class="fas fa-align-right text-xs"></i></button>
                                        </div>
                                    </div>

                                    <input type="text" id="wmTextName" value="Thong Tran" placeholder="Tiêu đề chính" class="w-full bg-white border border-zinc-200 px-4 py-3 text-xs text-zinc-900 focus:outline-none focus:border-accent font-medium shadow-sm">
                                    <!-- Changed to Textarea for multiline -->
                                    <textarea id="wmTextSub" rows="3" placeholder="Nội dung phụ (Enter để xuống dòng)" class="w-full bg-white border border-zinc-200 px-4 py-3 text-xs text-zinc-900 focus:outline-none focus:border-accent font-medium shadow-sm leading-relaxed" oninput="renderPreviews()">MY FIRST LENS</textarea>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2">
                                    <input type="radio" name="wmColor" id="color-white" value="#FFFFFF" checked class="hidden color-radio" onchange="renderPreviews()">
                                    <label for="color-white" class="py-2 border border-zinc-200 text-zinc-500 text-center text-[9px] font-bold uppercase cursor-pointer transition-all rounded-sm bg-white">White</label>
                                    
                                    <input type="radio" name="wmColor" id="color-black" value="#000000" class="hidden color-radio" onchange="renderPreviews()">
                                    <label for="color-black" class="py-2 border border-zinc-200 text-zinc-500 text-center text-[9px] font-bold uppercase cursor-pointer transition-all rounded-sm bg-white">Black</label>
                                    
                                    <input type="radio" name="wmColor" id="color-accent" value="#c5a059" class="hidden color-radio" onchange="renderPreviews()">
                                    <label for="color-accent" class="py-2 border border-zinc-200 text-zinc-500 text-center text-[9px] font-bold uppercase cursor-pointer transition-all rounded-sm bg-white">Gold</label>
                                </div>
                            </div>

                            <!-- Image Logo Input -->
                            <div id="image-settings-box" class="hidden">
                                <div class="relative group">
                                    <input type="file" id="logoInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewLogo()">
                                    <div class="bg-zinc-50 border border-zinc-200 py-3 px-4 text-center text-[10px] font-bold uppercase text-zinc-400 transition-all flex items-center justify-center gap-3">
                                        <i class="fas fa-image"></i> <span>Select Logo File</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Position -->
                            <div class="space-y-3">
                                <label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Placement</label>
                                <div class="flex gap-4">
                                    <div class="grid grid-cols-2 gap-1.5 w-1/2">
                                        <input type="radio" name="wmPos" id="pos-bl" value="bl" class="hidden pos-radio" onchange="renderPreviews()">
                                        <label for="pos-bl" class="py-2 border border-zinc-200 text-zinc-500 text-center text-[8px] font-bold uppercase cursor-pointer bg-white">Bot-L</label>
                                        <input type="radio" name="wmPos" id="pos-br" value="br" checked class="hidden pos-radio" onchange="renderPreviews()">
                                        <label for="pos-br" class="py-2 border border-zinc-200 text-zinc-500 text-center text-[8px] font-bold uppercase cursor-pointer bg-white">Bot-R</label>
                                    </div>
                                    <div class="grid grid-cols-3 gap-1.5 w-1/2 h-fit">
                                        <div></div><button onclick="moveStamp(0, -2)" class="bg-white border border-zinc-200 text-zinc-600 aspect-square hover:bg-zinc-100"><i class="fas fa-chevron-up text-[9px]"></i></button><div></div>
                                        <button onclick="moveStamp(-2, 0)" class="bg-white border border-zinc-200 text-zinc-600 aspect-square hover:bg-zinc-100"><i class="fas fa-chevron-left text-[9px]"></i></button>
                                        <button onclick="resetStamp()" class="bg-zinc-900 text-white aspect-square font-bold text-[10px] hover:bg-accent">R</button>
                                        <button onclick="moveStamp(2, 0)" class="bg-white border border-zinc-200 text-zinc-600 aspect-square hover:bg-zinc-100"><i class="fas fa-chevron-right text-[9px]"></i></button>
                                        <div></div><button onclick="moveStamp(0, 2)" class="bg-white border border-zinc-200 text-zinc-600 aspect-square hover:bg-zinc-100"><i class="fas fa-chevron-down text-[9px]"></i></button><div></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Scale -->
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Size</label>
                                    <span id="logo-size-val" class="text-[11px] font-bold text-accent">12%</span>
                                </div>
                                <input type="range" id="logoSize" min="3" max="45" value="12" class="w-full h-1 bg-zinc-200 rounded-lg appearance-none cursor-pointer accent-accent" oninput="updateSizeDisplay(this.value)" onchange="renderPreviews()">
                            </div>
                        </div>
                    </div>

                    <!-- Left: Preview Area -->
                    <div class="lg:col-span-8 space-y-10">
                        <div class="relative group">
                            <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="handleFileSelection()">
                            <div class="border border-dashed border-zinc-300 rounded-sm p-14 text-center group-hover:border-accent transition-colors bg-zinc-50">
                                <i class="fas fa-cloud-upload-alt text-4xl text-zinc-300 mb-4 block"></i>
                                <p class="text-[11px] uppercase tracking-[0.3em] font-bold text-zinc-400">Drag Photos Here</p>
                            </div>
                        </div>

                        <div id="preview-container" class="hidden space-y-6">
                            <div class="flex justify-between items-end border-b border-zinc-200 pb-4">
                                <p class="text-[11px] uppercase tracking-widest font-bold text-zinc-900">Staging (<span id="preview-count">0</span>)</p>
                                <button onclick="clearSelection()" class="text-[9px] uppercase font-bold text-red-400 hover:text-red-600 tracking-widest">Clear</button>
                            </div>
                            <div id="preview-grid" class="columns-2 lg:columns-3 gap-6 max-h-[600px] overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center gap-16 pt-8">
                    <button onclick="closeUploadModal()" class="text-[11px] uppercase font-bold tracking-[0.3em] text-zinc-400 hover:text-zinc-900 transition-colors">Cancel</button>
                    <button onclick="startUpload()" id="btn-upload-submit" class="bg-zinc-900 text-white px-16 py-5 text-[11px] font-bold uppercase tracking-[0.5em] hover:bg-accent transition-all shadow-2xl">
                        Start Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    
    <script>
        let currentAlbumId = null;
        let currentAlbumCoverUrl = ''; 
        let logoImageObj = null;
        let selectedFiles = []; 
        let currentRenderId = 0; 
        let stampOffsetX = 0; 
        let stampOffsetY = 0;
        
        // Settings State
        let textSettings = {
            bold: false,
            italic: false,
            align: 'left' // left, center, right
        };

        if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
        const db = firebase.firestore();

        // --- UI TOGGLES ---
        function toggleFormat(type) {
            textSettings[type] = !textSettings[type];
            document.getElementById(`btn-${type}`).classList.toggle('active', textSettings[type]);
            renderPreviews();
        }
        
        function toggleAlign(align) {
            textSettings.align = align;
            ['left', 'center', 'right'].forEach(a => {
                document.getElementById(`btn-align-${a}`).classList.toggle('active', a === align);
            });
            renderPreviews();
        }

        // --- AUTH ---
        function checkLogin() {
            if (document.getElementById('adminUser').value === 'admin' && document.getElementById('adminPass').value === 'admin') {
                localStorage.setItem('admin_auth_thongtran', 'true'); showDashboard();
            } else { Swal.fire({ icon: 'error', title: 'Error', text: 'Sai thông tin đăng nhập.' }); }
        }
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadAdminAlbums();
        }
        function logout() { localStorage.removeItem('admin_auth_thongtran'); location.reload(); }
        if(localStorage.getItem('admin_auth_thongtran') === 'true') showDashboard();

        function switchView(view) {
            const vA = document.getElementById('view-albums');
            const vP = document.getElementById('view-photos');
            if(view === 'photos') { vA.classList.add('hidden'); vP.classList.remove('hidden'); }
            else { vP.classList.add('hidden'); vA.classList.remove('hidden'); loadAdminAlbums(); }
        }

        // --- CORE FUNCTIONS (Stamp, Preview) ---
        function moveStamp(x, y) { stampOffsetX += x; stampOffsetY += y; renderPreviews(); }
        function resetStamp() { stampOffsetX = 0; stampOffsetY = 0; renderPreviews(); }
        function updateSizeDisplay(val) { document.getElementById('logo-size-val').innerText = val + '%'; }
        
        function toggleWMSettings() {
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            document.getElementById('text-config-panel').classList.toggle('hidden', wmType === 'image');
            document.getElementById('image-settings-box').classList.toggle('hidden', wmType !== 'image');
            renderPreviews();
        }

        function previewLogo() {
            const file = document.getElementById('logoInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => { logoImageObj = img; renderPreviews(); };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleFileSelection() {
            const input = document.getElementById('fileInput');
            if (input.files.length > 0) {
                selectedFiles = Array.from(input.files);
                document.getElementById('preview-container').classList.remove('hidden');
                renderPreviews();
            }
        }
        function clearSelection() { selectedFiles = []; document.getElementById('preview-grid').innerHTML = ''; document.getElementById('preview-container').classList.add('hidden'); }

        async function renderPreviews() {
            const grid = document.getElementById('preview-grid');
            const renderId = ++currentRenderId;
            grid.innerHTML = '';
            if (selectedFiles.length === 0) return;
            document.getElementById('preview-count').innerText = selectedFiles.length;

            const useWm = document.getElementById('useWatermark').checked;
            const useQR = document.getElementById('useQR').checked;
            const useBg = document.getElementById('useBackground').checked;
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const wmColor = document.querySelector('input[name="wmColor"]:checked').value;
            const wmPos = document.querySelector('input[name="wmPos"]:checked').value;
            const logoScale = document.getElementById('logoSize').value / 100;
            
            let textName = document.getElementById('wmTextName').value;
            let textSub = document.getElementById('wmTextSub').value;
            if(wmType === 'fixed_b') { textName = "Thong Tran"; textSub = "My First Lens"; }

            for (let i = 0; i < selectedFiles.length; i++) {
                if (renderId !== currentRenderId) return;
                const file = selectedFiles[i];
                const wrap = document.createElement('div');
                wrap.className = "mb-6 break-inside-avoid relative rounded-sm overflow-hidden bg-zinc-100 border border-zinc-200 shadow-sm";
                grid.appendChild(wrap);

                try {
                    const blob = await applyWatermark(file, useWm, useQR, useBg, wmType, wmColor, wmPos, logoImageObj, logoScale, textName, textSub, "PREVIEW", stampOffsetX, stampOffsetY);
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(blob);
                    img.className = "w-full h-auto block";
                    wrap.appendChild(img);
                } catch(e) { console.error(e); }
            }
        }

        // --- ENHANCED WATERMARK LOGIC (Multi-line + Formatting) ---
        function applyWatermark(file, useWm, useQR, useBg, type, color, pos, logoImage, logoScale, textName, textSub, docId, offX, offY) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width; canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const padding = canvas.width * 0.04;
                        if (useWm) {
                            if (type === 'image' && logoImage) {
                                // Logic ảnh cũ
                                const logoW = canvas.width * logoScale;
                                const logoH = (logoImage.height / logoImage.width) * logoW;
                                let lx, ly;
                                if (pos === 'br') { lx = canvas.width - logoW - padding; ly = canvas.height - logoH - padding; }
                                else if (pos === 'bl') { lx = padding; ly = canvas.height - logoH - padding; }
                                lx += (canvas.width * (offX / 100)); ly += (canvas.height * (offY / 100));
                                
                                if(useBg) {
                                    // Draw BG for Image
                                    const pad = logoW * 0.1;
                                    ctx.fillStyle = (color === '#000000') ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.4)';
                                    ctx.fillRect(lx-pad, ly-pad, logoW+pad*2, logoH+pad*2);
                                }
                                ctx.globalAlpha = 0.9; ctx.drawImage(logoImage, lx, ly, logoW, logoH); ctx.globalAlpha = 1.0;
                            } else {
                                // TEXT LOGIC
                                const baseSize = canvas.width * logoScale * 0.25;
                                const isSignature = type === 'fixed_b';
                                
                                // 1. Calculate Name Dimensions
                                ctx.font = isSignature ? `400 ${baseSize}px 'Great Vibes'` : `bold ${baseSize*0.8}px 'Playfair Display'`;
                                const nameMetrics = ctx.measureText(textName);
                                const nameH = baseSize;
                                
                                // 2. Calculate Multi-line Sub Dimensions
                                // Style
                                const subWeight = textSettings.bold ? 'bold' : '500';
                                const subStyle = textSettings.italic ? 'italic' : 'normal';
                                ctx.font = `${subStyle} ${subWeight} ${baseSize * 0.35}px 'Inter'`;
                                
                                const lines = textSub.split('\n');
                                const lineHeight = baseSize * 0.5; // Tăng khoảng cách dòng
                                let maxSubW = 0;
                                lines.forEach(l => {
                                    const w = ctx.measureText(l).width;
                                    if(w > maxSubW) maxSubW = w;
                                });
                                const subBlockH = lines.length * lineHeight;

                                const maxW = Math.max(nameMetrics.width, maxSubW);
                                const totalTextH = nameH + subBlockH + (baseSize * 0.2); // +gap

                                // QR
                                let qrS = 0; let qrCan = null;
                                if(useQR) {
                                    qrS = totalTextH * 0.8; // QR height relative to text block
                                    qrCan = document.createElement('canvas');
                                    await QRCode.toCanvas(qrCan, window.location.origin + '/view-photo.html?id=' + docId, { margin: 0, width: qrS, color: { dark: color, light: '#00000000' } });
                                }

                                const gapQR = baseSize * 0.5;
                                const totalW = maxW + (useQR ? gapQR + qrS : 0);
                                
                                // Box Position
                                let rx, ry;
                                if (pos === 'br') { rx = canvas.width - totalW - padding; ry = canvas.height - totalTextH - padding; }
                                else { rx = padding; ry = canvas.height - totalTextH - padding; }
                                rx += (canvas.width * (offX / 100)); ry += (canvas.height * (offY / 100));

                                // Draw Background (Glass Effect)
                                if (useBg) {
                                    const bgPadX = baseSize * 0.8;
                                    const bgPadY = baseSize * 0.6;
                                    const bgW = bgPadX + totalW + bgPadX;
                                    const bgH = bgPadY + totalTextH + bgPadY;
                                    const bgX = rx - bgPadX;
                                    const bgY = ry - bgPadY * 0.5 - (baseSize*0.5); // Adjust Y center

                                    ctx.save();
                                    ctx.beginPath();
                                    const r = baseSize * 0.2;
                                    ctx.moveTo(bgX + r, bgY); ctx.arcTo(bgX + bgW, bgY, bgX + bgW, bgY + bgH, r);
                                    ctx.arcTo(bgX + bgW, bgY + bgH, bgX, bgY + bgH, r);
                                    ctx.arcTo(bgX, bgY + bgH, bgX, bgY, r);
                                    ctx.arcTo(bgX, bgY, bgX + bgW, bgY, r); ctx.closePath();
                                    
                                    const isDark = color.toLowerCase() === '#000000';
                                    ctx.fillStyle = isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(0, 0, 0, 0.4)';
                                    ctx.fill(); 
                                    ctx.strokeStyle = isDark ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
                                    ctx.lineWidth = 1;
                                    ctx.stroke(); 
                                    ctx.restore();
                                }

                                // Draw Content
                                ctx.textAlign = textSettings.align; 
                                ctx.textBaseline = 'top';
                                ctx.fillStyle = color;
                                
                                // Calculate X align anchor
                                let anchorX = rx;
                                if(textSettings.align === 'center') anchorX = rx + maxW/2;
                                if(textSettings.align === 'right') anchorX = rx + maxW;

                                // 1. Name
                                ctx.font = isSignature ? `400 ${baseSize}px 'Great Vibes'` : `bold ${baseSize*0.8}px 'Playfair Display'`;
                                // Adjust Y to align baseline roughly
                                ctx.fillText(textName, anchorX, ry - (baseSize*0.6));
                                
                                // 2. Sub (Multi-line)
                                ctx.font = `${subStyle} ${subWeight} ${baseSize * 0.35}px 'Inter'`;
                                let currentY = ry + (baseSize * 0.5); // Gap after name
                                lines.forEach(line => {
                                    ctx.fillText(line, anchorX, currentY);
                                    currentY += lineHeight;
                                });

                                // 3. QR
                                if(useQR && qrCan) {
                                    // QR always to the right of text block for now
                                    const qrX = rx + maxW + gapQR;
                                    const qrY = ry - (baseSize*0.2);
                                    ctx.drawImage(qrCan, qrX, qrY, qrS, qrS);
                                }
                            }
                        }
                        canvas.toBlob(resolve, 'image/jpeg', 0.95);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- UPLOAD (FIXED: replaced currentBatchIndex with batchNumber) ---
        async function startUpload() {
            if(!selectedFiles.length) return;
            const btn = document.getElementById('btn-upload-submit');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="custom-loader !border-zinc-500"></span> Processing...';

            const BATCH_SIZE = 5; 
            const totalFiles = selectedFiles.length;
            const totalBatches = Math.ceil(totalFiles / BATCH_SIZE);
            let first = false;
            
            // Check if album empty
            const snap = await db.collection('photos').where('albumId', '==', currentAlbumId).limit(1).get();
            if(snap.empty) first = true;

            const useWm = document.getElementById('useWatermark').checked;
            const useQR = document.getElementById('useQR').checked;
            const useBg = document.getElementById('useBackground').checked; 
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const wmColor = document.querySelector('input[name="wmColor"]:checked').value;
            const wmPos = document.querySelector('input[name="wmPos"]:checked').value;
            const logoScale = document.getElementById('logoSize').value / 100;
            let textName = document.getElementById('wmTextName').value;
            let textSub = document.getElementById('wmTextSub').value;
            if(wmType === 'fixed_b') { textName = "Thong Tran"; textSub = "My First Lens"; }

            for (let i = 0; i < totalFiles; i += BATCH_SIZE) {
                const batchNumber = Math.floor(i / BATCH_SIZE) + 1;
                const batchFiles = selectedFiles.slice(i, i + BATCH_SIZE);
                
                btn.innerHTML = `<span class="custom-loader !border-zinc-500"></span> Batch ${batchNumber}/${totalBatches}...`;

                for (const file of batchFiles) {
                    const ref = db.collection('photos').doc();
                    try {
                        const blob = await applyWatermark(file, useWm, useQR, useBg, wmType, wmColor, wmPos, logoImageObj, logoScale, textName, textSub, ref.id, stampOffsetX, stampOffsetY);
                        const exif = await getExif(file);
                        
                        const fd = new FormData();
                        fd.append('file', blob);
                        fd.append('upload_preset', CONFIG.cloudinary.uploadPreset);
                        
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/image/upload`, { method: 'POST', body: fd });
                        const d = await res.json();

                        if(d.secure_url) {
                            await ref.set({
                                albumId: currentAlbumId,
                                url: d.secure_url,
                                likes: 0,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                exif: exif,
                                caption: ''
                            });
                            
                            await db.collection('albums').doc(currentAlbumId).update({ photoCount: firebase.firestore.FieldValue.increment(1) });
                            
                            if(first) {
                                await db.collection('albums').doc(currentAlbumId).update({ coverUrl: d.secure_url });
                                first = false;
                            }
                        }
                    } catch(e) { console.error("Upload failed", e); }
                }
                
                if (batchNumber < totalBatches) await new Promise(r => setTimeout(r, 500));
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
            closeUploadModal();
            loadAdminAlbums();
            if(!document.getElementById('view-photos').classList.contains('hidden')) loadPhotosInManager(currentAlbumId);
            Swal.fire({ icon: 'success', title: 'Upload Completed!', timer: 1500, showConfirmButton: false });
        }

        // --- HELPERS ---
        function getOptimizedUrl(url, w, h) {
            if (!url) return 'https://placehold.co/300x300/e5e7eb/a3a3a3?text=No+Image';
            if (url.includes('cloudinary.com')) return url.replace('/upload/', `/upload/w_${w},h_${h},c_fill,q_auto,f_auto/`);
            return url;
        }
        function getExif(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    let make = EXIF.getTag(this, "Make")||""; let model = EXIF.getTag(this, "Model")||"";
                    let camera = (make + " " + model).trim() || "Unknown";
                    resolve({ camera });
                });
            });
        }
        function openUpload(id) { currentAlbumId = id; clearSelection(); document.getElementById('uploadModal').classList.remove('hidden'); }
        function closeUploadModal() { document.getElementById('uploadModal').classList.add('hidden'); }
        
        async function loadAdminAlbums() {
            const list = document.getElementById('admin-album-list');
            list.innerHTML = '<p class="text-zinc-400 text-center">Loading...</p>';
            try {
                const snap = await db.collection('albums').orderBy('createdAt', 'desc').get();
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const img = getOptimizedUrl(d.coverUrl, 200, 200);
                    html += `
                    <div class="bg-white border border-zinc-200 p-6 flex justify-between items-center rounded-sm hover:shadow-md transition-all">
                        <div class="flex items-center gap-6 cursor-pointer" onclick="openPhotoManager('${doc.id}', '${d.title}')">
                            <img src="${img}" class="w-16 h-16 object-cover border border-zinc-100 grayscale group-hover:grayscale-0 rounded-sm">
                            <div><h3 class="font-display text-2xl text-zinc-900">${d.title}</h3><p class="text-[9px] uppercase tracking-widest text-accent">${d.photoCount||0} Photos</p></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openUpload('${doc.id}')" class="w-10 h-10 border border-zinc-200 text-zinc-400 hover:text-white hover:bg-zinc-900 flex items-center justify-center transition-all rounded-sm"><i class="fas fa-cloud-upload-alt"></i></button>
                            <button onclick="deleteAlbum('${doc.id}')" class="w-10 h-10 border border-zinc-200 text-zinc-400 hover:text-white hover:bg-red-500 hover:border-red-500 flex items-center justify-center transition-all rounded-sm"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
                list.innerHTML = html || '<p class="text-center text-zinc-300">Empty.</p>';
            } catch(e) { console.error(e); }
        }
        
        async function createNewAlbum() {
            const { value: form } = await Swal.fire({
                title: 'Tạo Album Mới',
                html: `
                    <div class="text-left space-y-4 p-4">
                        <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-accent tracking-widest">Tiêu đề</label><input id="swal-title" class="swal2-input !m-0 w-full" placeholder="Ví dụ: Mùa hè Đà Lạt"></div>
                        <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-accent tracking-widest">Mô tả</label><textarea id="swal-desc" class="swal2-textarea !m-0 w-full" rows="2"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-accent tracking-widest">Địa điểm</label><input id="swal-loc" class="swal2-input !m-0 w-full"></div>
                            <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-accent tracking-widest">Ngày chụp</label><input type="date" id="swal-date" class="swal2-input !m-0 w-full"></div>
                        </div>
                    </div>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'Tạo', width: '500px',
                preConfirm: () => ({
                    title: document.getElementById('swal-title').value,
                    description: document.getElementById('swal-desc').value,
                    location: document.getElementById('swal-loc').value,
                    dateTaken: document.getElementById('swal-date').value
                })
            });

            if(form && form.title) { 
                await db.collection('albums').add({ 
                    ...form,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
                    coverUrl: '', 
                    photoCount: 0 
                }); 
                loadAdminAlbums(); 
            }
        }

        async function deleteAlbum(id) {
            if((await Swal.fire({ title: 'Delete?', showCancelButton: true })).isConfirmed) { await db.collection('albums').doc(id).delete(); loadAdminAlbums(); }
        }
        
        async function openPhotoManager(id, title) { currentAlbumId = id; document.getElementById('current-album-title').innerText = title; switchView('photos'); loadPhotosInManager(id); }
        
        async function loadPhotosInManager(id) {
            const grid = document.getElementById('admin-photo-grid');
            grid.innerHTML = '<p class="col-span-full text-center text-zinc-400">Loading...</p>';
            const snap = await db.collection('photos').where('albumId', '==', id).orderBy('createdAt', 'desc').get();
            let html = '';
            snap.forEach(doc => {
                const d = doc.data();
                html += `<div class="aspect-square bg-white relative group border border-zinc-200 rounded-sm overflow-hidden shadow-sm"><img src="${getOptimizedUrl(d.url, 300, 300)}" class="w-full h-full object-cover"><button onclick="deletePhoto('${doc.id}')" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-sm"><i class="fas fa-times text-xs"></i></button></div>`;
            });
            grid.innerHTML = html || '<p class="col-span-full text-center text-zinc-300 italic">No photos.</p>';
        }
        
        async function deletePhoto(id) {
            if(confirm('Delete photo?')) { 
                await db.collection('photos').doc(id).delete(); 
                await db.collection('albums').doc(currentAlbumId).update({ photoCount: firebase.firestore.FieldValue.increment(-1) });
                loadPhotosInManager(currentAlbumId); 
            }
        }
        
        async function downloadAlbumZip() {
            if(!currentAlbumId) return;
            const btn = document.getElementById('btn-download-zip');
            const original = btn.innerHTML;
            btn.innerHTML = 'Zipping...'; btn.disabled = true;
            try {
                const zip = new JSZip();
                const snap = await db.collection('photos').where('albumId', '==', currentAlbumId).get();
                const folder = zip.folder("photos");
                
                await Promise.all(snap.docs.map(async (doc) => {
                    const url = doc.data().url.replace('http://', 'https://');
                    const blob = await fetch(url).then(r => r.blob());
                    folder.file(`photo_${doc.id}.jpg`, blob);
                }));
                
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `album_${currentAlbumId}.zip`);
            } catch(e) { alert('Zip failed: ' + e.message); }
            btn.innerHTML = original; btn.disabled = false;
        }
    </script>
</body>
</html>
