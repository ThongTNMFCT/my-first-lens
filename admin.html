<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Thong Tran Photography</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        accent: '#c5a059',
                        darkPanel: '#111111'
                    }
                }
            }
        }
    </script>
    <style>
        .swal2-popup { border-radius: 0px !important; font-family: 'Inter', sans-serif !important; border: 1px solid #eee; }
        .swal2-title { font-family: 'Playfair Display', serif !important; font-style: italic; font-weight: 400 !important; }
        .swal2-confirm { background-color: #000 !important; border-radius: 0px !important; text-transform: uppercase; letter-spacing: 0.1em; font-size: 11px !important; padding: 12px 24px !important; }
        .swal2-input, .swal2-textarea { border-radius: 0px !important; font-size: 13px !important; border: 1px solid #eee !important; box-shadow: none !important; }
        
        .custom-loader {
            width: 20px; height: 20px; border: 2px solid #fff; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #eee; }

        .color-radio:checked + label { border-color: #c5a059; background-color: rgba(197, 160, 89, 0.1); color: #c5a059; }
        .type-radio:checked + label { background-color: #000; color: #fff; border-color: #000; }
        .pos-radio:checked + label { border-color: #000; background-color: #000; color: #fff; }

        input[type=range]::-webkit-slider-runnable-track { background: #e5e7eb; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #c5a059; margin-top: -6px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        
        .preview-columns { columns: 2; column-gap: 1.5rem; }
        @media (min-width: 640px) { .preview-columns { columns: 3; } }
        .preview-item { break-inside: avoid; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="bg-[#fafafa] font-sans text-zinc-900 antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-white flex items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-12 text-center">
            <div class="space-y-4">
                <h1 class="font-serif text-4xl italic font-light">Thong Tran<span class="text-accent">.</span></h1>
                <p class="text-[9px] uppercase tracking-[0.4em] text-zinc-400 font-bold">Secure Administrative Access</p>
            </div>
            <div class="space-y-6 text-left">
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Identity</label>
                    <input type="text" id="adminUser" value="admin" class="w-full border-b border-zinc-200 py-3 focus:outline-none focus:border-accent transition-colors bg-transparent text-sm">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Credential</label>
                    <input type="password" id="adminPass" value="admin" class="w-full border-b border-zinc-200 py-3 focus:outline-none focus:border-accent transition-colors bg-transparent text-sm">
                </div>
            </div>
            <button onclick="checkLogin()" class="w-full bg-zinc-900 text-white py-4 text-[10px] font-bold uppercase tracking-[0.3em] hover:bg-accent transition-all duration-500">Unlock Portal</button>
        </div>
    </div>

    <!-- Dashboard Main -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-72 bg-white border-r border-zinc-100 flex-shrink-0 flex flex-col h-auto md:h-screen sticky top-0 z-20">
            <div class="p-8 border-b border-zinc-50 flex justify-between items-center md:block space-y-2">
                <span class="font-serif font-bold text-2xl italic tracking-tighter" onclick="location.reload()" class="cursor-pointer text-zinc-900">Portal<span class="text-accent">.</span></span>
                <p class="text-[8px] uppercase tracking-widest text-zinc-400 font-bold hidden md:block">Management System</p>
                <button onclick="logout()" class="md:hidden text-zinc-400"><i class="fas fa-power-off"></i></button>
            </div>
            <nav class="flex-1 p-6 space-y-1 text-[10px] font-bold uppercase tracking-widest">
                <a href="index.html" target="_blank" class="flex items-center gap-4 p-4 rounded-sm hover:bg-zinc-50 text-zinc-400 hover:text-accent transition-all"><i class="fas fa-external-link-alt w-4"></i> Live Site</a>
                <div class="h-px bg-zinc-50 my-4"></div>
                <button onclick="switchView('albums')" class="w-full flex items-center gap-4 p-4 rounded-sm hover:bg-zinc-50 text-zinc-400 hover:text-accent transition-all"><i class="fas fa-th-large w-4"></i> Albums</button>
                <button onclick="createNewAlbum()" class="w-full flex items-center gap-4 p-4 rounded-sm bg-zinc-900 text-white hover:bg-accent transition-all shadow-lg mt-4"><i class="fas fa-plus w-4"></i> Create Album</button>
            </nav>
            <div class="p-8 border-t border-zinc-50 hidden md:block">
                <button onclick="logout()" class="flex items-center gap-3 text-red-400 hover:text-red-600 transition-colors text-[10px] font-bold uppercase tracking-widest"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
            </div>
        </aside>

        <main class="flex-1 p-8 md:p-16 overflow-auto">
            <div id="view-albums" class="animate-fade-in">
                <div class="mb-12 text-center md:text-left">
                    <h2 class="font-serif text-4xl italic mb-2">My Collections</h2>
                    <p class="text-[10px] uppercase tracking-[0.3em] text-zinc-400 font-bold">Manage your photography archives</p>
                </div>
                <div id="admin-album-list" class="grid grid-cols-1 gap-6 max-w-5xl mx-auto md:mx-0"></div>
            </div>
            <div id="view-photos" class="hidden animate-fade-in">
                <div class="flex items-center gap-6 mb-12 border-b border-zinc-100 pb-8">
                    <button onclick="switchView('albums')" class="w-12 h-12 rounded-full border border-zinc-200 flex items-center justify-center hover:bg-zinc-900 hover:text-white transition-all group"><i class="fas fa-arrow-left text-xs"></i></button>
                    <div>
                        <h2 id="current-album-title" class="font-serif text-3xl italic">Album Title</h2>
                        <p class="text-[9px] uppercase tracking-[0.3em] text-zinc-400 font-bold mt-1">Image Asset Management</p>
                    </div>
                </div>
                <div id="admin-photo-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
            </div>
        </main>
    </div>

    <!-- Upload Overlay -->
    <div id="uploadModal" class="hidden fixed inset-0 bg-white/98 backdrop-blur-xl z-[150] flex items-center justify-center p-6 overflow-y-auto">
        <div class="w-full max-w-7xl space-y-8 py-10">
            <div class="text-center space-y-2">
                <h3 class="font-serif text-4xl italic">Archive Assets</h3>
                <p class="text-[9px] uppercase tracking-[0.3em] text-zinc-400 font-bold">Select high-quality photographs</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-start">
                <!-- Left: Settings -->
                <div class="lg:col-span-4 bg-zinc-50 border border-zinc-100 p-6 space-y-6 rounded-sm sticky top-0">
                    <div class="flex items-center justify-between border-b border-zinc-200 pb-4">
                        <p class="text-[9px] uppercase tracking-widest font-bold text-zinc-500">Stamp Configuration</p>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="useWatermark" checked class="w-4 h-4 accent-zinc-900" onchange="renderPreviews()">
                            <span class="text-[10px] font-bold uppercase tracking-widest">Active</span>
                        </label>
                    </div>

                    <div class="space-y-5">
                        <!-- QR Code Option -->
                        <div class="flex items-center justify-between bg-white p-3 border border-zinc-200 rounded-sm shadow-sm">
                            <div class="space-y-1">
                                <span class="text-[10px] font-bold uppercase tracking-widest block">Gắn mã QR Link</span>
                                <span class="text-[8px] text-zinc-400">(Sẽ được nhúng chung vào stamp)</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="useQR" class="sr-only peer" onchange="renderPreviews()">
                                <div class="w-9 h-5 bg-zinc-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-zinc-900"></div>
                            </label>
                        </div>

                        <!-- Type Selection -->
                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-zinc-400 tracking-wider">Stamp Type</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="radio" name="wmType" id="type-custom" value="custom" checked class="hidden type-radio" onchange="toggleWMSettings()">
                                <label for="type-custom" class="py-2 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 transition-all bg-white rounded-sm">Tùy chỉnh</label>
                                
                                <input type="radio" name="wmType" id="type-fixed-a" value="fixed_a" class="hidden type-radio" onchange="toggleWMSettings()">
                                <label for="type-fixed-a" class="py-2 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 transition-all bg-white rounded-sm">Style A</label>

                                <input type="radio" name="wmType" id="type-fixed-b" value="fixed_b" class="hidden type-radio" onchange="toggleWMSettings()">
                                <label for="type-fixed-b" class="py-2 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 transition-all bg-white rounded-sm">Style B (Index)</label>

                                <input type="radio" name="wmType" id="type-image" value="image" class="hidden type-radio" onchange="toggleWMSettings()">
                                <label for="type-image" class="py-2 text-center text-[9px] font-bold uppercase cursor-pointer border border-zinc-200 transition-all bg-white rounded-sm">Logo Ảnh</label>
                            </div>
                        </div>

                        <!-- Text Customization Panel -->
                        <div id="text-config-panel" class="space-y-4">
                            <div id="custom-text-inputs" class="space-y-3">
                                <div class="space-y-1">
                                    <label class="text-[9px] uppercase font-bold text-zinc-400">Dòng 1</label>
                                    <input type="text" id="wmTextName" value="I'm Thong Tran" class="w-full bg-white border border-zinc-200 px-3 py-2 text-xs focus:outline-none focus:border-accent" oninput="renderPreviews()">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[9px] uppercase font-bold text-zinc-400">Dòng 2</label>
                                    <input type="text" id="wmTextSub" value="MY FIRST LENS" class="w-full bg-white border border-zinc-200 px-3 py-2 text-xs focus:outline-none focus:border-accent" oninput="renderPreviews()">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[9px] uppercase font-bold text-zinc-400">Màu sắc</label>
                                <div class="flex gap-2">
                                    <input type="radio" name="wmColor" id="color-white" value="#FFFFFF" checked class="hidden color-radio" onchange="renderPreviews()">
                                    <label for="color-white" class="flex-1 py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Trắng</label>
                                    <input type="radio" name="wmColor" id="color-black" value="#000000" class="hidden color-radio" onchange="renderPreviews()">
                                    <label for="color-black" class="flex-1 py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Đen</label>
                                    <input type="radio" name="wmColor" id="color-accent" value="#c5a059" class="hidden color-radio" onchange="renderPreviews()">
                                    <label for="color-accent" class="flex-1 py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Vàng</label>
                                </div>
                            </div>
                        </div>

                        <!-- Logo Upload Panel -->
                        <div id="image-settings-box" class="hidden space-y-3">
                            <label class="text-[9px] uppercase font-bold text-zinc-400">Tải lên Logo (.png)</label>
                            <div class="relative">
                                <input type="file" id="logoInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewLogo()">
                                <div id="logo-preview-btn" class="bg-white border border-zinc-200 py-2 px-4 text-center text-[10px] font-bold uppercase transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-image"></i> <span>Chọn Logo</span>
                                </div>
                            </div>
                        </div>

                        <!-- Position Selection -->
                        <div class="space-y-2">
                            <label class="text-[9px] uppercase font-bold text-zinc-400 tracking-wider">Vị trí</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="radio" name="wmPos" id="pos-tl" value="tl" class="hidden pos-radio" onchange="renderPreviews()">
                                <label for="pos-tl" class="py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Trên-Trái</label>
                                <input type="radio" name="wmPos" id="pos-tr" value="tr" class="hidden pos-radio" onchange="renderPreviews()">
                                <label for="pos-tr" class="py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Trên-Phải</label>
                                <input type="radio" name="wmPos" id="pos-bl" value="bl" class="hidden pos-radio" onchange="renderPreviews()">
                                <label for="pos-bl" class="py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Dưới-Trái</label>
                                <input type="radio" name="wmPos" id="pos-br" value="br" checked class="hidden pos-radio" onchange="renderPreviews()">
                                <label for="pos-br" class="py-2 border border-zinc-200 text-center text-[9px] font-bold uppercase cursor-pointer transition-all bg-white">Dưới-Phải</label>
                            </div>
                        </div>

                        <!-- Size Slider -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Kích cỡ Stamp</label>
                                <span id="logo-size-val" class="text-[10px] font-bold text-accent">15%</span>
                            </div>
                            <input type="range" id="logoSize" min="5" max="50" value="15" class="w-full h-1 bg-zinc-200 rounded-lg appearance-none cursor-pointer accent-accent" oninput="updateSizeDisplay(this.value)" onchange="renderPreviews()">
                        </div>
                    </div>
                </div>

                <!-- Right: Previews -->
                <div class="lg:col-span-8 space-y-8">
                    <div class="relative group">
                        <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="handleFileSelection()">
                        <div class="border border-dashed border-zinc-200 rounded-sm p-10 text-center group-hover:border-accent transition-colors bg-white shadow-sm">
                            <div id="upload-placeholder" class="space-y-3">
                                <i class="fas fa-camera text-xl text-zinc-300"></i>
                                <p class="text-[10px] uppercase tracking-[0.2em] font-bold text-zinc-400">Thả ảnh vào đây hoặc nhấn để chọn</p>
                            </div>
                        </div>
                    </div>

                    <div id="preview-container" class="hidden space-y-4">
                        <div class="flex justify-between items-end border-b border-zinc-100 pb-2">
                            <p class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Xem trước kết quả (<span id="preview-count">0</span> ảnh)</p>
                            <button onclick="clearSelection()" class="text-[9px] uppercase font-bold text-red-400 hover:text-red-600 transition-colors">Xóa tất cả</button>
                        </div>
                        <div id="preview-grid" class="preview-columns max-h-[600px] overflow-y-auto pr-4 py-2"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-12 pt-8">
                <button onclick="closeUploadModal()" class="text-[10px] uppercase font-bold tracking-[0.2em] text-zinc-400 hover:text-zinc-900 transition-colors">Hủy bỏ</button>
                <button onclick="startUpload()" id="btn-upload-submit" class="bg-zinc-900 text-white px-12 py-5 text-[10px] font-bold uppercase tracking-[0.4em] hover:bg-accent transition-all shadow-2xl">Bắt đầu Upload</button>
            </div>
        </div>
    </div>

    <canvas id="wm-canvas" class="hidden"></canvas>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    
    <script>
        let currentAlbumId = null;
        let logoImageObj = null;
        let selectedFiles = []; 
        let currentRenderId = 0; 

        if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
        const db = firebase.firestore();

        // --- AUTH ---
        function checkLogin() {
            if (document.getElementById('adminUser').value === 'admin' && document.getElementById('adminPass').value === 'admin') {
                localStorage.setItem('admin_auth_thongtran', 'true'); showDashboard();
            } else { Swal.fire({ icon: 'error', title: 'Unauthorized', text: 'Sai thông tin đăng nhập.', confirmButtonColor: '#000' }); }
        }
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadAdminAlbums();
        }
        function logout() { localStorage.removeItem('admin_auth_thongtran'); location.reload(); }
        if(localStorage.getItem('admin_auth_thongtran') === 'true') showDashboard();

        function switchView(view) {
            const vA = document.getElementById('view-albums');
            const vP = document.getElementById('view-photos');
            if(view === 'photos') { vA.classList.add('hidden'); vP.classList.remove('hidden'); }
            else { vP.classList.add('hidden'); vA.classList.remove('hidden'); loadAdminAlbums(); }
        }

        // --- UI TOGGLES ---
        function toggleWMSettings() {
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const textPanel = document.getElementById('text-config-panel');
            const customInputs = document.getElementById('custom-text-inputs');
            const imageBox = document.getElementById('image-settings-box');

            textPanel.classList.toggle('hidden', wmType === 'image');
            customInputs.classList.toggle('hidden', wmType !== 'custom');
            imageBox.classList.toggle('hidden', wmType !== 'image');
            
            renderPreviews();
        }
        function updateSizeDisplay(val) { document.getElementById('logo-size-val').innerText = val + '%'; }
        function previewLogo() {
            const file = document.getElementById('logoInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    logoImageObj = img;
                    document.getElementById('logo-preview-btn').innerHTML = `<i class="fas fa-check text-green-500"></i> <span>Logo Ready</span>`;
                    renderPreviews();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- PREVIEW LOGIC ---
        function handleFileSelection() {
            const input = document.getElementById('fileInput');
            if (input.files.length > 0) {
                selectedFiles = Array.from(input.files);
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
                renderPreviews();
            }
        }
        function clearSelection() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('preview-grid').innerHTML = '';
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
        }

        async function renderPreviews() {
            const grid = document.getElementById('preview-grid');
            const countDisplay = document.getElementById('preview-count');
            const renderId = ++currentRenderId;
            grid.innerHTML = '';
            if (selectedFiles.length === 0) return;
            countDisplay.innerText = selectedFiles.length;

            const useWm = document.getElementById('useWatermark').checked;
            const useQR = document.getElementById('useQR').checked;
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const wmColor = document.querySelector('input[name="wmColor"]:checked').value;
            const wmPos = document.querySelector('input[name="wmPos"]:checked').value;
            const logoScale = document.getElementById('logoSize').value / 100;
            
            let textName, textSub;
            if(wmType === 'fixed_a') {
                textName = "I'm Thong Tran"; textSub = "MY FIRST LENS";
            } else if(wmType === 'fixed_b') {
                textName = "ThongTran."; textSub = "My First Lens";
            } else {
                textName = document.getElementById('wmTextName').value || "";
                textSub = document.getElementById('wmTextSub').value || "";
            }

            for (let file of selectedFiles) {
                if (renderId !== currentRenderId) return;

                const itemWrap = document.createElement('div');
                itemWrap.className = "preview-item bg-zinc-50 rounded-sm overflow-hidden relative border border-zinc-100 shadow-sm animate-fade-in";
                const loader = document.createElement('div');
                loader.className = "absolute inset-0 flex items-center justify-center bg-white/40 z-10";
                loader.innerHTML = '<span class="custom-loader !border-zinc-300"></span>';
                itemWrap.appendChild(loader);
                grid.appendChild(itemWrap);

                try {
                    const mockId = "PREVIEW_ID";
                    const previewBlob = await applyWatermark(file, useWm, useQR, wmType, wmColor, wmPos, logoImageObj, logoScale, textName, textSub, mockId);
                    if (renderId !== currentRenderId) { itemWrap.remove(); continue; }
                    const url = URL.createObjectURL(previewBlob);
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = "w-full h-auto block";
                    img.onload = () => { loader.remove(); };
                    itemWrap.appendChild(img);
                } catch (err) { console.error(err); }
            }
        }

        // --- CORE WATERMARK PROCESSING ---
        function applyWatermark(file, useWm, useQR, type, color, pos, logoImage, logoScale, textName, textSub, docId) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const padding = canvas.width * 0.04;

                        if (useWm) {
                            if (type === 'image' && logoImage) {
                                // Draw Logo Image
                                const logoW = canvas.width * logoScale;
                                const logoH = (logoImage.height / logoImage.width) * logoW;
                                let logoX, logoY;
                                if (pos === 'br') { logoX = canvas.width - logoW - padding; logoY = canvas.height - logoH - padding; }
                                else if (pos === 'bl') { logoX = padding; logoY = canvas.height - logoH - padding; }
                                else if (pos === 'tr') { logoX = canvas.width - logoW - padding; logoY = padding; }
                                else { logoX = padding; logoY = padding; }

                                // If QR active, embed in box? Prompt says embed QR with stamp.
                                // Let's create a glass box even for logo image if QR is active.
                                if(useQR) {
                                    const qrS = canvas.width * 0.08;
                                    const photoUrl = window.location.origin + '/view-photo.html?id=' + docId;
                                    const qrCanvas = document.createElement('canvas');
                                    await QRCode.toCanvas(qrCanvas, photoUrl, { margin: 1, width: qrS });
                                    
                                    const combinedW = Math.max(logoW, qrS) + (padding*0.5);
                                    const combinedH = logoH + qrS + (padding*0.8);
                                    
                                    // Simplification: We'll mainly focus text embedding for QR as requested
                                }
                                ctx.globalAlpha = 0.95; ctx.drawImage(logoImage, logoX, logoY, logoW, logoH); ctx.globalAlpha = 1.0;
                            } else {
                                // Draw Text Stamp (Can contain QR)
                                const baseSize = canvas.width * logoScale * 0.3; 
                                const isStyleB = type === 'fixed_b';
                                
                                // Measures
                                ctx.font = isStyleB ? `700 ${baseSize}px 'Playfair Display'` : `italic bold ${baseSize}px 'Playfair Display'`;
                                const line1W = ctx.measureText(textName).width;
                                ctx.font = `700 ${baseSize * 0.42}px 'Inter'`;
                                const line2W = ctx.measureText(textSub).width;
                                
                                // QR Measure
                                let qrS = 0;
                                let qrCanvas = null;
                                if(useQR) {
                                    qrS = canvas.width * 0.08;
                                    const photoUrl = window.location.origin + '/view-photo.html?id=' + docId;
                                    qrCanvas = document.createElement('canvas');
                                    await QRCode.toCanvas(qrCanvas, photoUrl, { margin: 1, width: qrS });
                                }

                                const maxW = Math.max(line1W, line2W, qrS);
                                const bgPadX = baseSize * 0.8;
                                const bgPadY = baseSize * 0.6;
                                const bgW = maxW + (bgPadX * 2);
                                
                                // Calculate bgHeight based on components
                                let bgH = (baseSize * 2.2) + (bgPadY * 2);
                                if(useQR) bgH += qrS + (baseSize * 0.5);

                                let rectX, rectY, stampX, stampY;
                                // Simplified positioning for all corners
                                if (pos === 'br') { rectX = canvas.width - bgW - padding; rectY = canvas.height - bgH - padding; }
                                else if (pos === 'bl') { rectX = padding; rectY = canvas.height - bgH - padding; }
                                else if (pos === 'tr') { rectX = canvas.width - bgW - padding; rectY = padding; }
                                else { rectX = padding; rectY = padding; }

                                stampX = rectX + (bgW / 2);
                                stampY = rectY + bgPadY + (baseSize * 0.85);

                                // Glass Background
                                ctx.save();
                                ctx.beginPath();
                                const r = baseSize * 0.5;
                                ctx.moveTo(rectX + r, rectY);
                                ctx.arcTo(rectX + bgW, rectY, rectX + bgW, rectY + bgH, r);
                                ctx.arcTo(rectX + bgW, rectY + bgH, rectX, rectY + bgH, r);
                                ctx.arcTo(rectX, rectY + bgH, rectX, rectY, r);
                                ctx.arcTo(rectX, rectY, rectX + bgW, rectY, r);
                                ctx.closePath();
                                const isDark = color.toLowerCase() === '#000000';
                                ctx.fillStyle = isDark ? 'rgba(255, 255, 255, 0.45)' : 'rgba(0, 0, 0, 0.38)';
                                ctx.fill();
                                ctx.strokeStyle = isDark ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.15)';
                                ctx.stroke();
                                ctx.restore();

                                // Drawing Text (Always centered within the stamp box now)
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Line 1
                                if(isStyleB) {
                                    const textWithoutDot = "ThongTran";
                                    ctx.font = `700 ${baseSize}px 'Playfair Display'`;
                                    const fullW = ctx.measureText("ThongTran.").width;
                                    const startX = stampX - (fullW / 2);
                                    
                                    ctx.textAlign = 'left';
                                    ctx.fillStyle = color;
                                    ctx.fillText(textWithoutDot, startX, stampY);
                                    const nameW = ctx.measureText(textWithoutDot).width;
                                    ctx.fillStyle = '#c5a059'; // Gold dot
                                    ctx.fillText(".", startX + nameW, stampY);
                                } else {
                                    ctx.fillStyle = color;
                                    ctx.font = `italic bold ${baseSize}px 'Playfair Display'`;
                                    ctx.fillText(textName, stampX, stampY);
                                }

                                // Line 2
                                ctx.textAlign = 'center';
                                ctx.fillStyle = color;
                                ctx.font = `700 ${baseSize * 0.42}px 'Inter'`;
                                const line2Y = stampY + (baseSize * 0.9);
                                ctx.fillText(textSub, stampX, line2Y);

                                // QR Integrated inside box
                                if(useQR && qrCanvas) {
                                    const qrY = line2Y + (baseSize * 0.8);
                                    ctx.globalAlpha = 0.85;
                                    ctx.drawImage(qrCanvas, stampX - (qrS / 2), qrY, qrS, qrS);
                                    ctx.globalAlpha = 1.0;
                                }
                            }
                        } else if (useQR) {
                            // Only QR, separate corner logic
                            const qrS = canvas.width * 0.08;
                            const photoUrl = window.location.origin + '/view-photo.html?id=' + docId;
                            const qrCanvas = document.createElement('canvas');
                            await QRCode.toCanvas(qrCanvas, photoUrl, { margin: 1, width: qrS });
                            let qrX, qrY;
                            if (pos === 'br') { qrX = canvas.width - qrS - padding; qrY = canvas.height - qrS - padding; }
                            else if (pos === 'bl') { qrX = padding; qrY = canvas.height - qrS - padding; }
                            else if (pos === 'tr') { qrX = canvas.width - qrS - padding; qrY = padding; }
                            else { qrX = padding; qrY = padding; }
                            ctx.save(); ctx.globalAlpha = 0.85; ctx.drawImage(qrCanvas, qrX, qrY, qrS, qrS); ctx.restore();
                        }

                        canvas.toBlob((b) => resolve(b), 'image/jpeg', 0.92);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- ALBUMS MGMT ---
        async function loadAdminAlbums() {
            const container = document.getElementById('admin-album-list');
            container.innerHTML = '<p class="text-center py-10 text-zinc-400">Đang tải dữ liệu...</p>';
            try {
                const snap = await db.collection('albums').orderBy('createdAt', 'desc').get();
                if(snap.empty) { container.innerHTML = '<p class="text-[11px] text-zinc-400 text-center">No albums found.</p>'; return; }
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const cover = d.coverUrl ? d.coverUrl.replace('/upload/', '/upload/w_200,h_200,c_fill/') : 'https://placehold.co/200x200?text=Empty';
                    html += `<div class="bg-white p-6 border border-zinc-100 flex flex-col md:flex-row justify-between items-center hover:shadow-lg transition-all gap-6"><div class="flex items-center gap-8 w-full cursor-pointer group" onclick="openPhotoManager('${doc.id}', '${d.title.replace(/'/g, "\\'")}')"><img src="${cover}" class="w-20 h-20 object-cover grayscale group-hover:grayscale-0 transition-all duration-700"><div><h3 class="font-serif text-2xl italic group-hover:text-accent transition-colors">${d.title}</h3><div class="flex gap-4 mt-1"><span class="text-[8px] font-bold uppercase tracking-widest text-zinc-400"><i class="fas fa-map-marker-alt mr-1"></i> ${d.location || '--'}</span><span class="text-[8px] font-bold uppercase tracking-widest text-zinc-400"><i class="fas fa-images mr-1"></i> ${d.photoCount || 0} ITEMS</span></div></div></div><div class="flex gap-2 w-full md:w-auto justify-end"><button onclick="openUpload('${doc.id}')" class="w-10 h-10 border border-zinc-100 hover:bg-zinc-900 hover:text-white transition-all"><i class="fas fa-cloud-upload-alt text-[10px]"></i></button><button onclick="editAlbum('${doc.id}')" class="w-10 h-10 border border-zinc-100 hover:bg-zinc-900 hover:text-white transition-all"><i class="fas fa-pen text-[10px]"></i></button><button onclick="deleteAlbum('${doc.id}')" class="w-10 h-10 border border-zinc-100 hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-trash text-[10px]"></i></button></div></div>`;
                });
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function createNewAlbum() {
            const { value: form } = await Swal.fire({
                title: 'New Album',
                html: `<div class="text-left space-y-4 p-2"><input id="swal-title" class="swal2-input !m-0 w-full" placeholder="Title"><textarea id="swal-desc" class="swal2-textarea !m-0 w-full" placeholder="Description"></textarea><div class="grid grid-cols-2 gap-2"><input id="swal-loc" class="swal2-input !m-0 w-full" placeholder="Location"><input type="date" id="swal-date" class="swal2-input !m-0 w-full"></div></div>`,
                focusConfirm: false, showCancelButton: true,
                preConfirm: () => ({ title: document.getElementById('swal-title').value, description: document.getElementById('swal-desc').value, location: document.getElementById('swal-loc').value, dateTaken: document.getElementById('swal-date').value })
            });
            if (form && form.title) {
                await db.collection('albums').add({ ...form, createdAt: firebase.firestore.FieldValue.serverTimestamp(), coverUrl: '', photoCount: 0 });
                loadAdminAlbums();
            }
        }

        async function editAlbum(id) {
            const doc = await db.collection('albums').doc(id).get();
            const d = doc.data();
            const { value: form } = await Swal.fire({
                title: 'Edit Album',
                html: `<div class="text-left space-y-4 p-2"><input id="swal-e-title" class="swal2-input !m-0 w-full" value="${d.title}"><textarea id="swal-e-desc" class="swal2-textarea !m-0 w-full">${d.description||''}</textarea><div class="grid grid-cols-2 gap-2"><input id="swal-e-loc" class="swal2-input !m-0 w-full" value="${d.location||''}"><input type="date" id="swal-e-date" class="swal2-input !m-0 w-full" value="${d.dateTaken||''}"></div></div>`,
                focusConfirm: false, showCancelButton: true,
                preConfirm: () => ({ title: document.getElementById('swal-e-title').value, description: document.getElementById('swal-e-desc').value, location: document.getElementById('swal-e-loc').value, dateTaken: document.getElementById('swal-e-date').value })
            });
            if (form) { await db.collection('albums').doc(id).update(form); loadAdminAlbums(); }
        }

        async function deleteAlbum(id) {
            const res = await Swal.fire({ title: 'Purge Album?', text: "Hành động không thể hoàn tác!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' });
            if (res.isConfirmed) { await db.collection('albums').doc(id).delete(); loadAdminAlbums(); }
        }

        async function openPhotoManager(id, title) {
            currentAlbumId = id; document.getElementById('current-album-title').innerText = title;
            switchView('photos'); loadPhotosInGrid(id);
        }
        async function loadPhotosInGrid(albumId) {
            const grid = document.getElementById('admin-photo-grid');
            grid.innerHTML = '<p class="col-span-full text-[11px] animate-pulse text-center py-10">Loading assets...</p>';
            try {
                const snap = await db.collection('photos').where('albumId', '==', albumId).orderBy('createdAt', 'desc').get();
                if(snap.empty) { grid.innerHTML = '<p class="col-span-full text-[11px] text-zinc-400 text-center py-10">Empty.</p>'; return; }
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const thumb = d.url.replace('/upload/', '/upload/w_300,h_300,c_fill/'); 
                    html += `<div class="bg-white border border-zinc-100 rounded-sm overflow-hidden group relative animate-fade-in shadow-sm"><div class="aspect-square relative overflow-hidden"><img src="${thumb}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700"><div class="absolute inset-0 bg-zinc-900/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4"><button onclick="deletePhoto('${doc.id}')" class="text-white hover:text-red-500"><i class="fas fa-trash"></i></button></div></div><div class="p-3"><p class="text-[9px] font-bold truncate uppercase tracking-widest">${d.caption || 'Untitled'}</p></div></div>`;
                });
                grid.innerHTML = html;
            } catch (e) { console.error(e); }
        }
        async function deletePhoto(id) {
            const res = await Swal.fire({ title: 'Delete?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#000' });
            if (res.isConfirmed) {
                await db.collection('photos').doc(id).delete();
                await db.collection('albums').doc(currentAlbumId).update({ photoCount: firebase.firestore.FieldValue.increment(-1) });
                loadPhotosInGrid(currentAlbumId);
            }
        }

        // --- UPLOAD CORE ---
        function openUpload(id) { currentAlbumId = id; clearSelection(); document.getElementById('uploadModal').classList.remove('hidden'); }
        function closeUploadModal() { document.getElementById('uploadModal').classList.add('hidden'); }
        function getExif(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    let make = EXIF.getTag(this, "Make") || ""; let model = EXIF.getTag(this, "Model") || "";
                    let camera = (make + " " + model).trim().replace(/canon canon/i, "Canon") || "Unknown Camera";
                    let fn = EXIF.getTag(this, "FNumber"); let aperture = fn ? `f/${fn}` : "";
                    let iso = EXIF.getTag(this, "ISOSpeedRatings"); let isoStr = iso ? `ISO ${iso}` : "";
                    let exp = EXIF.getTag(this, "ExposureTime");
                    let shutter = (exp && exp.numerator) ? `${exp.numerator}/${exp.denominator}s` : (exp ? `${exp}s` : "");
                    resolve({ camera, aperture, iso: isoStr, shutter });
                });
            });
        }

        async function startUpload() {
            if(!selectedFiles.length) return;
            const useWm = document.getElementById('useWatermark').checked;
            const useQR = document.getElementById('useQR').checked;
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const wmColor = document.querySelector('input[name="wmColor"]:checked').value;
            const wmPos = document.querySelector('input[name="wmPos"]:checked').value;
            const logoScale = document.getElementById('logoSize').value / 100;
            
            let textName, textSub;
            if(wmType === 'fixed_a') { textName = "I'm Thong Tran"; textSub = "MY FIRST LENS"; }
            else if(wmType === 'fixed_b') { textName = "ThongTran."; textSub = "My First Lens"; }
            else { textName = document.getElementById('wmTextName').value; textSub = document.getElementById('wmTextSub').value; }

            const btn = document.getElementById('btn-upload-submit');
            btn.disabled = true; btn.innerHTML = '<span class="custom-loader"></span> Syncing...';

            for(let file of selectedFiles) {
                const exif = await getExif(file);
                const photoDocRef = db.collection('photos').doc();
                const photoId = photoDocRef.id;
                try {
                    const finalBlob = await applyWatermark(file, useWm, useQR, wmType, wmColor, wmPos, logoImageObj, logoScale, textName, textSub, photoId);
                    const fd = new FormData(); fd.append('file', finalBlob); fd.append('upload_preset', CONFIG.cloudinary.uploadPreset);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/image/upload`, { method: 'POST', body: fd });
                    const data = await res.json();
                    if(data.secure_url) {
                        await photoDocRef.set({ albumId: currentAlbumId, url: data.secure_url, likes: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp(), exif, caption: '' });
                        await db.collection('albums').doc(currentAlbumId).update({ coverUrl: data.secure_url, photoCount: firebase.firestore.FieldValue.increment(1) });
                    }
                } catch(e) { console.error(e); }
            }
            btn.disabled = false; btn.innerHTML = 'Start Upload';
            closeUploadModal(); loadAdminAlbums();
            Swal.fire({ icon: 'success', title: 'Hoàn tất!', timer: 1500, showConfirmButton: false });
        }
    </script>
</body>
</html>