<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Thong Tran Photography</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Utilities -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        accent: '#c5a059',
                        darkPanel: '#111111'
                    }
                }
            }
        }
    </script>
    <style>
        .swal2-popup { border-radius: 0px !important; font-family: 'Inter', sans-serif !important; border: 1px solid #eee; }
        .swal2-title { font-family: 'Playfair Display', serif !important; font-style: italic; font-weight: 400 !important; }
        .swal2-confirm { background-color: #000 !important; border-radius: 0px !important; text-transform: uppercase; letter-spacing: 0.1em; font-size: 11px !important; padding: 12px 24px !important; }
        .swal2-input, .swal2-textarea { border-radius: 0px !important; font-size: 13px !important; border: 1px solid #eee !important; box-shadow: none !important; }
        
        .custom-loader {
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #eee; }
    </style>
</head>
<body class="bg-[#fafafa] font-sans text-zinc-900 antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[100] bg-white flex items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-12 text-center">
            <div class="space-y-4">
                <h1 class="font-serif text-4xl italic font-light">Thong Tran<span class="text-accent">.</span></h1>
                <p class="text-[9px] uppercase tracking-[0.4em] text-zinc-400 font-bold">Secure Administrative Access</p>
            </div>
            
            <div class="space-y-6 text-left">
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Identity</label>
                    <input type="text" id="adminUser" value="admin" class="w-full border-b border-zinc-200 py-3 focus:outline-none focus:border-accent transition-colors bg-transparent text-sm">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] uppercase tracking-widest font-bold text-zinc-400">Credential</label>
                    <input type="password" id="adminPass" value="admin" class="w-full border-b border-zinc-200 py-3 focus:outline-none focus:border-accent transition-colors bg-transparent text-sm">
                </div>
            </div>

            <button onclick="checkLogin()" class="w-full bg-zinc-900 text-white py-4 text-[10px] font-bold uppercase tracking-[0.3em] hover:bg-accent transition-all duration-500">
                Unlock Portal
            </button>
        </div>
    </div>

    <!-- Dashboard Main -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col md:flex-row">
        
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-72 bg-white border-r border-zinc-100 flex-shrink-0 flex flex-col h-auto md:h-screen sticky top-0 z-20">
            <div class="p-8 border-b border-zinc-50 flex justify-between items-center md:block space-y-2">
                <span class="font-serif font-bold text-2xl italic tracking-tighter">Portal<span class="text-accent">.</span></span>
                <p class="text-[8px] uppercase tracking-widest text-zinc-400 font-bold hidden md:block">Management System</p>
                <button onclick="logout()" class="md:hidden text-zinc-400"><i class="fas fa-power-off"></i></button>
            </div>
            
            <nav class="flex-1 p-6 space-y-1 text-[10px] font-bold uppercase tracking-widest">
                <a href="index.html" target="_blank" class="flex items-center gap-4 p-4 rounded-sm hover:bg-zinc-50 text-zinc-400 hover:text-accent transition-all">
                    <i class="fas fa-external-link-alt w-4"></i> Live Site
                </a>
                <div class="h-px bg-zinc-50 my-4"></div>
                <button onclick="switchView('albums')" class="w-full flex items-center gap-4 p-4 rounded-sm hover:bg-zinc-50 text-zinc-400 hover:text-accent transition-all">
                    <i class="fas fa-th-large w-4"></i> Albums
                </button>
                <button onclick="createNewAlbum()" class="w-full flex items-center gap-4 p-4 rounded-sm bg-zinc-900 text-white hover:bg-accent transition-all shadow-lg mt-4">
                    <i class="fas fa-plus w-4"></i> Create Album
                </button>
            </nav>

            <div class="p-8 border-t border-zinc-50 hidden md:block">
                <button onclick="logout()" class="flex items-center gap-3 text-red-400 hover:text-red-600 transition-colors text-[10px] font-bold uppercase tracking-widest">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 p-8 md:p-16 overflow-auto">
            
            <!-- Albums View -->
            <div id="view-albums" class="animate-fade-in">
                <div class="mb-12">
                    <h2 class="font-serif text-4xl italic mb-2">My Collections</h2>
                    <p class="text-[10px] uppercase tracking-[0.3em] text-zinc-400 font-bold">Manage your photography archives</p>
                </div>
                
                <div id="admin-album-list" class="grid grid-cols-1 gap-6 max-w-5xl">
                    <!-- Album Items -->
                </div>
            </div>

            <!-- Photos Manager View -->
            <div id="view-photos" class="hidden animate-fade-in">
                <div class="flex items-center gap-6 mb-12 border-b border-zinc-100 pb-8">
                    <button onclick="switchView('albums')" class="w-12 h-12 rounded-full border border-zinc-200 flex items-center justify-center hover:bg-zinc-900 hover:text-white transition-all group">
                        <i class="fas fa-arrow-left text-xs"></i>
                    </button>
                    <div>
                        <h2 id="current-album-title" class="font-serif text-3xl italic">Album Title</h2>
                        <p class="text-[9px] uppercase tracking-[0.3em] text-zinc-400 font-bold mt-1">Image Asset Management</p>
                    </div>
                </div>

                <div id="admin-photo-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- Photo Grid Items -->
                </div>
            </div>

        </main>
    </div>

    <!-- Upload Overlay -->
    <div id="uploadModal" class="hidden fixed inset-0 bg-white/95 backdrop-blur-xl z-[150] flex items-center justify-center p-6">
        <div class="w-full max-w-xl space-y-12">
            <div class="text-center space-y-4">
                <h3 class="font-serif text-4xl italic">Archive Assets</h3>
                <p class="text-[9px] uppercase tracking-[0.3em] text-zinc-400 font-bold">Select high-quality photographs for upload</p>
            </div>

            <div class="relative group">
                <input type="file" id="fileInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onchange="updateFileCount()">
                <div class="border border-dashed border-zinc-200 rounded-sm p-16 text-center group-hover:border-accent transition-colors">
                    <div id="upload-placeholder" class="space-y-4">
                        <i class="fas fa-cloud-upload-alt text-2xl text-zinc-200"></i>
                        <p class="text-[10px] uppercase tracking-[0.2em] font-bold text-zinc-400">Click or Drag images here</p>
                    </div>
                    <div id="file-count-display" class="hidden animate-fade-in space-y-2">
                        <p class="text-4xl font-serif italic text-accent" id="count-num">0</p>
                        <p class="text-[9px] uppercase tracking-widest font-bold text-zinc-400">Items Staged</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-center gap-8">
                <button onclick="closeUploadModal()" class="text-[10px] uppercase font-bold tracking-widest text-zinc-400 hover:text-zinc-900 transition-colors">Cancel</button>
                <button onclick="startUpload()" id="btn-upload-submit" class="bg-zinc-900 text-white px-10 py-4 text-[10px] font-bold uppercase tracking-[0.3em] hover:bg-accent transition-all shadow-xl">
                    Push to Cloud
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>
    
    <script>
        let currentAlbumId = null;
        if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
        const db = firebase.firestore();

        // --- AUTH ---
        function checkLogin() {
            if (document.getElementById('adminUser').value === 'admin' && document.getElementById('adminPass').value === 'admin') {
                localStorage.setItem('admin_auth_thongtran', 'true'); 
                showDashboard();
            } else { 
                Swal.fire({ icon: 'error', title: 'Unauthorized', text: 'Invalid administrative credentials.', confirmButtonColor: '#000' }); 
            }
        }
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadAdminAlbums();
        }
        function logout() { localStorage.removeItem('admin_auth_thongtran'); location.reload(); }
        if(localStorage.getItem('admin_auth_thongtran') === 'true') showDashboard();

        function switchView(view) {
            const vA = document.getElementById('view-albums');
            const vP = document.getElementById('view-photos');
            if(view === 'photos') { vA.classList.add('hidden'); vP.classList.remove('hidden'); }
            else { vP.classList.add('hidden'); vA.classList.remove('hidden'); loadAdminAlbums(); }
        }

        // --- ALBUMS ---
        async function loadAdminAlbums() {
            const container = document.getElementById('admin-album-list');
            container.innerHTML = '<div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-zinc-100 w-3/4"></div><div class="h-4 bg-zinc-100"></div></div></div>';
            
            try {
                const snap = await db.collection('albums').orderBy('createdAt', 'desc').get();
                if(snap.empty) { container.innerHTML = '<p class="text-[11px] text-zinc-400">No archives created yet.</p>'; return; }
                
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const cover = d.coverUrl ? d.coverUrl.replace('/upload/', '/upload/w_200,h_200,c_fill/') : 'https://placehold.co/200x200?text=Empty';

                    html += `
                    <div class="bg-white p-6 border border-zinc-100 rounded-sm flex flex-col md:flex-row justify-between items-center hover:shadow-xl transition-all gap-6 animate-fade-in">
                        <div class="flex items-center gap-8 w-full cursor-pointer group" onclick="openPhotoManager('${doc.id}', '${d.title.replace(/'/g, "\\'")}')">
                            <img src="${cover}" class="w-20 h-20 object-cover grayscale group-hover:grayscale-0 transition-all duration-700">
                            <div class="min-w-0">
                                <h3 class="font-serif text-2xl italic group-hover:text-accent transition-colors">${d.title}</h3>
                                <div class="flex gap-4 mt-2">
                                    <span class="text-[8px] font-bold uppercase tracking-widest text-zinc-400"><i class="fas fa-map-marker-alt mr-1"></i> ${d.location || '--'}</span>
                                    <span class="text-[8px] font-bold uppercase tracking-widest text-zinc-400"><i class="fas fa-images mr-1"></i> ${d.photoCount || 0} ITEMS</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button onclick="openUpload('${doc.id}')" class="w-10 h-10 border border-zinc-100 flex items-center justify-center hover:bg-zinc-900 hover:text-white transition-all"><i class="fas fa-cloud-upload-alt text-[10px]"></i></button>
                            <button onclick="editAlbum('${doc.id}')" class="w-10 h-10 border border-zinc-100 flex items-center justify-center hover:bg-zinc-900 hover:text-white transition-all"><i class="fas fa-pen text-[10px]"></i></button>
                            <button onclick="deleteAlbum('${doc.id}')" class="w-10 h-10 border border-zinc-100 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-trash text-[10px]"></i></button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function createNewAlbum() {
            const { value: form } = await Swal.fire({
                title: 'New Archive',
                html: `
                    <div class="text-left space-y-4 p-4">
                        <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Title</label><input id="swal-title" class="swal2-input !m-0 w-full" placeholder="e.g. Summer in Da Lat"></div>
                        <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Description</label><textarea id="swal-desc" class="swal2-textarea !m-0 w-full" rows="2"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Location</label><input id="swal-loc" class="swal2-input !m-0 w-full"></div>
                            <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-zinc-400 tracking-widest">Date</label><input type="date" id="swal-date" class="swal2-input !m-0 w-full"></div>
                        </div>
                    </div>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'Initialize', width: '500px',
                preConfirm: () => ({
                    title: document.getElementById('swal-title').value,
                    description: document.getElementById('swal-desc').value,
                    location: document.getElementById('swal-loc').value,
                    dateTaken: document.getElementById('swal-date').value
                })
            });

            if (form && form.title) {
                await db.collection('albums').add({
                    ...form,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    coverUrl: '',
                    photoCount: 0
                });
                loadAdminAlbums();
            }
        }

        async function editAlbum(id) {
            const doc = await db.collection('albums').doc(id).get();
            const d = doc.data();
            const { value: form } = await Swal.fire({
                title: 'Modify Archive',
                html: `<div class="text-left space-y-4 p-4">
                    <input id="swal-e-title" class="swal2-input !m-0 w-full" value="${d.title}">
                    <textarea id="swal-e-desc" class="swal2-textarea !m-0 w-full">${d.description || ''}</textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="swal-e-loc" class="swal2-input !m-0 w-full" value="${d.location || ''}">
                        <input type="date" id="swal-e-date" class="swal2-input !m-0 w-full" value="${d.dateTaken || ''}">
                    </div>
                </div>`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'Update', width: '500px',
                preConfirm: () => ({
                    title: document.getElementById('swal-e-title').value,
                    description: document.getElementById('swal-e-desc').value,
                    location: document.getElementById('swal-e-loc').value,
                    dateTaken: document.getElementById('swal-e-date').value
                })
            });
            if (form) { await db.collection('albums').doc(id).update(form); loadAdminAlbums(); }
        }

        async function deleteAlbum(id) {
            const res = await Swal.fire({ title: 'Purge Archive?', text: "Permanent destruction. Are you certain?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Delete' });
            if (res.isConfirmed) { await db.collection('albums').doc(id).delete(); loadAdminAlbums(); }
        }

        // --- PHOTOS ---
        async function openPhotoManager(id, title) {
            currentAlbumId = id;
            document.getElementById('current-album-title').innerText = title;
            switchView('photos');
            loadPhotosInGrid(id);
        }

        async function loadPhotosInGrid(albumId) {
            const grid = document.getElementById('admin-photo-grid');
            grid.innerHTML = '<p class="col-span-full text-[11px] text-zinc-400 animate-pulse">Retrieving assets...</p>';
            try {
                const snap = await db.collection('photos').where('albumId', '==', albumId).orderBy('createdAt', 'desc').get();
                if(snap.empty) { grid.innerHTML = '<p class="col-span-full text-[11px] text-zinc-400">Archive is currently empty.</p>'; return; }

                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const thumb = d.url.replace('/upload/', '/upload/w_300,h_300,c_fill/'); 
                    const exif = d.exif || {};

                    html += `
                    <div class="bg-white border border-zinc-100 rounded-sm overflow-hidden group relative">
                        <div class="aspect-square bg-zinc-50 relative overflow-hidden">
                            <img src="${thumb}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700">
                            <div class="absolute inset-0 bg-zinc-900/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4">
                                <button onclick='editPhoto("${doc.id}", "${(d.caption||'').replace(/"/g, '&quot;')}")' class="text-white hover:text-accent"><i class="fas fa-pen"></i></button>
                                <button onclick="deletePhoto('${doc.id}')" class="text-white hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="p-4 space-y-1">
                            <p class="text-[9px] font-bold truncate uppercase tracking-widest">${d.caption || 'Untitled'}</p>
                            <p class="text-[8px] text-zinc-400 font-bold uppercase truncate">${exif.camera || 'EXIF N/A'}</p>
                        </div>
                    </div>`;
                });
                grid.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function deletePhoto(id) {
            const res = await Swal.fire({ title: 'Remove Asset?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#000' });
            if (res.isConfirmed) {
                await db.collection('photos').doc(id).delete();
                await db.collection('albums').doc(currentAlbumId).update({ photoCount: firebase.firestore.FieldValue.increment(-1) });
                loadPhotosInGrid(currentAlbumId);
            }
        }

        async function editPhoto(id, cap) {
            const { value: caption } = await Swal.fire({ title: 'Modify Caption', input: 'text', inputValue: cap, showCancelButton: true });
            if (caption !== undefined) {
                await db.collection('photos').doc(id).update({ caption });
                loadPhotosInGrid(currentAlbumId);
            }
        }

        // --- UPLOAD ---
        function openUpload(id) {
            currentAlbumId = id;
            document.getElementById('fileInput').value = ''; 
            document.getElementById('file-count-display').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('uploadModal').classList.remove('hidden');
        }
        function closeUploadModal() { document.getElementById('uploadModal').classList.add('hidden'); }
        function updateFileCount() {
            const files = document.getElementById('fileInput').files;
            if (files.length > 0) {
                document.getElementById('upload-placeholder').classList.add('hidden');
                document.getElementById('file-count-display').classList.remove('hidden');
                document.getElementById('count-num').innerText = files.length;
            }
        }

        function getExif(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    let make = EXIF.getTag(this, "Make") || ""; let model = EXIF.getTag(this, "Model") || "";
                    let camera = (make + " " + model).trim().replace(/canon canon/i, "Canon") || "Unknown Camera";
                    let fn = EXIF.getTag(this, "FNumber"); let aperture = fn ? `f/${fn}` : "";
                    let iso = EXIF.getTag(this, "ISOSpeedRatings"); let isoStr = iso ? `ISO ${iso}` : "";
                    let exp = EXIF.getTag(this, "ExposureTime");
                    let shutter = (exp && exp.numerator) ? `${exp.numerator}/${exp.denominator}s` : (exp ? `${exp}s` : "");
                    resolve({ camera, aperture, iso: isoStr, shutter });
                });
            });
        }

        async function startUpload() {
            const files = document.getElementById('fileInput').files;
            if(!files.length) return;
            const btn = document.getElementById('btn-upload-submit');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="custom-loader"></span>';

            for(let file of files) {
                const exif = await getExif(file);
                const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CONFIG.cloudinary.uploadPreset);
                try {
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/image/upload`, { method: 'POST', body: fd });
                    const data = await res.json();
                    if(data.secure_url) {
                        await db.collection('photos').add({
                            albumId: currentAlbumId,
                            url: data.secure_url,
                            likes: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            exif,
                            caption: '' 
                        });
                        await db.collection('albums').doc(currentAlbumId).update({ coverUrl: data.secure_url, photoCount: firebase.firestore.FieldValue.increment(1) });
                    }
                } catch(e) { console.error(e); }
            }
            btn.disabled = false; btn.innerHTML = originalText;
            closeUploadModal(); loadAdminAlbums();
            if(!document.getElementById('view-photos').classList.contains('hidden')) loadPhotosInGrid(currentAlbumId);
            Swal.fire({ icon: 'success', title: 'Transmission Complete', timer: 1500, showConfirmButton: false });
        }
    </script>
</body>
</html>